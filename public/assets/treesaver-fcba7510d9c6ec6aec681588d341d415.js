// Input 0
// Copyright 2006 The Closure Library Authors. All Rights Reserved.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS-IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
/**
 * @fileoverview Bootstrap for the Google JS Library (Closure).
 *
 * In uncompiled mode base.js will write out Closure's deps file, unless the
 * global <code>CLOSURE_NO_DEPS</code> is set to true.  This allows projects to
 * include their own deps file(s) from different locations.
 *
 */
/**
 * @define {boolean} Overridden to true by the compiler when --closure_pass
 *     or --mark_as_compiled is specified.
 */
var COMPILED=!0,goog=goog||{};goog.global=this,goog.DEBUG=!0,goog.LOCALE="en",goog.evalWorksForGlobals_=null,goog.provide=function(e){if(!COMPILED){if(goog.getObjectByName(e)&&!goog.implicitNamespaces_[e])throw Error('Namespace "'+e+'" already declared.');var t=e;while(t=t.substring(0,t.lastIndexOf(".")))goog.implicitNamespaces_[t]=!0}goog.exportPath_(e)},goog.setTestOnly=function(e){if(COMPILED&&!goog.DEBUG)throw e=e||"",Error("Importing test-only code into non-debug environment"+e?": "+e:".")},COMPILED||(goog.implicitNamespaces_={}),goog.exportPath_=function(e,t,n){var r=e.split("."),i=n||goog.global;!(r[0]in i)&&i.execScript&&i.execScript("var "+r[0]);for(var s;r.length&&(s=r.shift());)!r.length&&goog.isDef(t)?i[s]=t:i[s]?i=i[s]:i=i[s]={}},goog.getObjectByName=function(e,t){var n=e.split("."),r=t||goog.global;for(var i;i=n.shift();){if(!goog.isDefAndNotNull(r[i]))return null;r=r[i]}return r},goog.globalize=function(e,t){var n=t||goog.global;for(var r in e)n[r]=e[r]},goog.addDependency=function(e,t,n){if(!COMPILED){var r,i,s=e.replace(/\\/g,"/"),o=goog.dependencies_;for(var u=0;r=t[u];u++)o.nameToPath[r]=s,s in o.pathToNames||(o.pathToNames[s]={}),o.pathToNames[s][r]=!0;for(var a=0;i=n[a];a++)s in o.requires||(o.requires[s]={}),o.requires[s][i]=!0}},goog.require=function(e){if(!COMPILED){if(goog.getObjectByName(e))return;var t=goog.getPathFromDeps_(e);if(!t){var n="goog.require could not find: "+e;throw goog.global.console&&goog.global.console.error(n),Error(n)}goog.included_[t]=!0,goog.writeScripts_()}},goog.basePath="",goog.global.CLOSURE_BASE_PATH,goog.global.CLOSURE_NO_DEPS,goog.global.CLOSURE_IMPORT_SCRIPT,goog.nullFunction=function(){},goog.identityFunction=function(e){return arguments[0]},goog.abstractMethod=function(){throw Error("unimplemented abstract method")},goog.addSingletonGetter=function(e){e.getInstance=function(){return e.instance_||(e.instance_=new e)}},COMPILED||(goog.included_={},goog.dependencies_={pathToNames:{},nameToPath:{},requires:{},visited:{},written:{}},goog.inHtmlDocument_=function(){var e=goog.global.document;return typeof e!="undefined"&&"write"in e},goog.findBasePath_=function(){if(goog.global.CLOSURE_BASE_PATH){goog.basePath=goog.global.CLOSURE_BASE_PATH;return}if(!goog.inHtmlDocument_())return;var e=goog.global.document,t=e.getElementsByTagName("script");for(var n=t.length-1;n>=0;--n){var r=t[n].src,i=r.lastIndexOf("?"),s=i==-1?r.length:i;if(r.substr(s-7,7)=="base.js"){goog.basePath=r.substr(0,s-7);return}}},goog.importScript_=function(e){var t=goog.global.CLOSURE_IMPORT_SCRIPT||goog.writeScriptTag_;!goog.dependencies_.written[e]&&t(e)&&(goog.dependencies_.written[e]=!0)},goog.writeScriptTag_=function(e){if(goog.inHtmlDocument_()){var t=goog.global.document;return t.write('<script type="text/javascript" src="'+e+'"></'+"script>"),!0}return!1},goog.writeScripts_=function(){function r(i){if(i in n.written)return;if(i in n.visited){i in t||(t[i]=!0,e.push(i));return}n.visited[i]=!0;if(i in n.requires)for(var s in n.requires[i])if(s in n.nameToPath)r(n.nameToPath[s]);else if(!goog.getObjectByName(s))throw Error("Undefined nameToPath for "+s);i in t||(t[i]=!0,e.push(i))}var e=[],t={},n=goog.dependencies_;for(var i in goog.included_)n.written[i]||r(i);for(var s=0;s<e.length;s++){if(!e[s])throw Error("Undefined script input");goog.importScript_(goog.basePath+e[s])}},goog.getPathFromDeps_=function(e){return e in goog.dependencies_.nameToPath?goog.dependencies_.nameToPath[e]:null},goog.findBasePath_(),goog.global.CLOSURE_NO_DEPS||goog.importScript_(goog.basePath+"deps.js")),goog.typeOf=function(e){var t=typeof e;if(t=="object"){if(!e)return"null";if(e instanceof Array)return"array";if(e instanceof Object)return t;var n=Object.prototype.toString.call(e);if(n=="[object Window]")return"object";if(n=="[object Array]"||typeof e.length=="number"&&typeof e.splice!="undefined"&&typeof e.propertyIsEnumerable!="undefined"&&!e.propertyIsEnumerable("splice"))return"array";if(n=="[object Function]"||typeof e.call!="undefined"&&typeof e.propertyIsEnumerable!="undefined"&&!e.propertyIsEnumerable("call"))return"function"}else if(t=="function"&&typeof e.call=="undefined")return"object";return t},goog.propertyIsEnumerableCustom_=function(e,t){if(t in e)for(var n in e)if(n==t&&Object.prototype.hasOwnProperty.call(e,t))return!0;return!1},goog.propertyIsEnumerable_=function(e,t){return e instanceof Object?Object.prototype.propertyIsEnumerable.call(e,t):goog.propertyIsEnumerableCustom_(e,t)},goog.isDef=function(e){return e!==undefined},goog.isNull=function(e){return e===null},goog.isDefAndNotNull=function(e){return e!=null},goog.isArray=function(e){return goog.typeOf(e)=="array"},goog.isArrayLike=function(e){var t=goog.typeOf(e);return t=="array"||t=="object"&&typeof e.length=="number"},goog.isDateLike=function(e){return goog.isObject(e)&&typeof e.getFullYear=="function"},goog.isString=function(e){return typeof e=="string"},goog.isBoolean=function(e){return typeof e=="boolean"},goog.isNumber=function(e){return typeof e=="number"},goog.isFunction=function(e){return goog.typeOf(e)=="function"},goog.isObject=function(e){var t=goog.typeOf(e);return t=="object"||t=="array"||t=="function"},goog.getUid=function(e){return e[goog.UID_PROPERTY_]||(e[goog.UID_PROPERTY_]=++goog.uidCounter_)},goog.removeUid=function(e){"removeAttribute"in e&&e.removeAttribute(goog.UID_PROPERTY_);try{delete e[goog.UID_PROPERTY_]}catch(t){}},goog.UID_PROPERTY_="closure_uid_"+Math.floor(Math.random()*2147483648).toString(36),goog.uidCounter_=0,goog.getHashCode=goog.getUid,goog.removeHashCode=goog.removeUid,goog.cloneObject=function(e){var t=goog.typeOf(e);if(t=="object"||t=="array"){if(e.clone)return e.clone();var n=t=="array"?[]:{};for(var r in e)n[r]=goog.cloneObject(e[r]);return n}return e},Object.prototype.clone,goog.bindNative_=function(e,t,n){return e.call.apply(e.bind,arguments)},goog.bindJs_=function(e,t,n){var r=t||goog.global;if(arguments.length>2){var i=Array.prototype.slice.call(arguments,2);return function(){var t=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(t,i),e.apply(r,t)}}return function(){return e.apply(r,arguments)}},goog.bind=function(e,t,n){return Function.prototype.bind&&Function.prototype.bind.toString().indexOf("native code")!=-1?goog.bind=goog.bindNative_:goog.bind=goog.bindJs_,goog.bind.apply(null,arguments)},goog.partial=function(e,t){var n=Array.prototype.slice.call(arguments,1);return function(){var t=Array.prototype.slice.call(arguments);return t.unshift.apply(t,n),e.apply(this,t)}},goog.mixin=function(e,t){for(var n in t)e[n]=t[n]},goog.now=Date.now||function(){return+(new Date)},goog.globalEval=function(e){if(goog.global.execScript)goog.global.execScript(e,"JavaScript");else{if(!goog.global.eval)throw Error("goog.globalEval not available");goog.evalWorksForGlobals_==null&&(goog.global.eval("var _et_ = 1;"),typeof goog.global["_et_"]!="undefined"?(delete goog.global._et_,goog.evalWorksForGlobals_=!0):goog.evalWorksForGlobals_=!1);if(goog.evalWorksForGlobals_)goog.global.eval(e);else{var t=goog.global.document,n=t.createElement("script");n.type="text/javascript",n.defer=!1,n.appendChild(t.createTextNode(e)),t.body.appendChild(n),t.body.removeChild(n)}}},goog.cssNameMapping_,goog.cssNameMappingStyle_,goog.getCssName=function(e,t){var n=function(e){return goog.cssNameMapping_[e]||e},r=function(e){var t=e.split("-"),r=[];for(var i=0;i<t.length;i++)r.push(n(t[i]));return r.join("-")},i;return goog.cssNameMapping_?i=goog.cssNameMappingStyle_=="BY_WHOLE"?n:r:i=function(e){return e},t?e+"-"+i(t):i(e)},goog.setCssNameMapping=function(e,t){goog.cssNameMapping_=e,goog.cssNameMappingStyle_=t},goog.getMsg=function(e,t){var n=t||{};for(var r in n){var i=(""+n[r]).replace(/\$/g,"$$$$");e=e.replace(new RegExp("\\{\\$"+r+"\\}","gi"),i)}return e},goog.exportSymbol=function(e,t,n){goog.exportPath_(e,t,n)},goog.exportProperty=function(e,t,n){e[t]=n},goog.inherits=function(e,t){function n(){}n.prototype=t.prototype,e.superClass_=t.prototype,e.prototype=new n,e.prototype.constructor=e},goog.base=function(e,t,n){var r=arguments.callee.caller;if(r.superClass_)return r.superClass_.constructor.apply(e,Array.prototype.slice.call(arguments,1));var i=Array.prototype.slice.call(arguments,2),s=!1;for(var o=e.constructor;o;o=o.superClass_&&o.superClass_.constructor)if(o.prototype[t]===r)s=!0;else if(s)return o.prototype[t].apply(e,i);if(e[t]===r)return e.constructor.prototype[t].apply(e,i);throw Error("goog.base called from a method of one name to a method of a different name")},goog.scope=function(e){e.call(goog.global)},goog.provide("treesaver.scheduler"),treesaver.scheduler.TASK_INTERVAL=25,treesaver.scheduler.tasks_=[],treesaver.scheduler.namedTasks_={},treesaver.scheduler.taskWhitelist_=null,treesaver.scheduler.tickID_,treesaver.scheduler.tick_=function(){var e=goog.now();treesaver.scheduler.tasks_.forEach(function(t,n){if(!treesaver.scheduler.tickID_)return;if(t.removed)return;if(treesaver.scheduler.taskWhitelist_)if(!t.name||treesaver.scheduler.taskWhitelist_.indexOf(t.name)===-1)return;if(e-t.last<=t.interval)return;t.last=e,t.times-=1;if(t.times<=0)if(!t.immediate||t.times<0){treesaver.array.remove(treesaver.scheduler.tasks_,n),delete treesaver.scheduler.namedTasks_[t.name];if(t.immediate)return}t.fun.apply(t.obj,t.args)}),treesaver.scheduler.tasks_.length||treesaver.scheduler.stopAll()},treesaver.scheduler.addTask_=function(e,t,n,r,i,s,o){var u=goog.now(),a=s?treesaver.scheduler.namedTasks_[s]:null;if(goog.DEBUG&&!e.apply){treesaver.debug.error("Function without apply() not added to the scheduler");return}a||(a={fun:e,name:s,obj:o,last:i?-Infinity:u},treesaver.scheduler.tasks_.push(a),s&&(treesaver.scheduler.namedTasks_[s]=a)),a.args=r||[],a.times=n,a.interval=Math.max(t,treesaver.scheduler.TASK_INTERVAL),a.immediate=i,a.removed=!1,treesaver.scheduler.tickID_||(treesaver.scheduler.tickID_=window.setInterval(treesaver.scheduler.tick_,treesaver.scheduler.TASK_INTERVAL))},treesaver.scheduler.delay=function(e,t,n,r,i){treesaver.scheduler.addTask_(e,t,1,n,!1,r,i)},treesaver.scheduler.repeat=function(e,t,n,r,i,s){treesaver.scheduler.addTask_(e,t,n,r,!1,i,s)},treesaver.scheduler.queue=function(e,t,n,r){treesaver.scheduler.addTask_(e,0,1,t,!1,n,r)},treesaver.scheduler.debounce=function(e,t,n,r,i,s){var o=treesaver.scheduler.namedTasks_[i];o?o.last=goog.now():treesaver.scheduler.addTask_(e,t,1,n,r,i,s)},treesaver.scheduler.limit=function(e,t,n,r,i){var s=treesaver.scheduler.namedTasks_[r];s||treesaver.scheduler.addTask_(e,t,1,n,!0,r,i)},treesaver.scheduler.pause=function(e,t){treesaver.scheduler.taskWhitelist_=e,t&&(treesaver.scheduler.pauseTimeoutId_=setTimeout(treesaver.scheduler.resume,t))},treesaver.scheduler.resume=function(){treesaver.scheduler.taskWhitelist_=null,treesaver.scheduler.pauseTimeoutId_&&(window.clearTimeout(treesaver.scheduler.pauseTimeoutId_),treesaver.scheduler.pauseTimeoutId_=null)},treesaver.scheduler.clear=function(e){delete treesaver.scheduler.namedTasks_[e],treesaver.scheduler.tasks_.forEach(function(t,n){t.name===e&&(treesaver.array.remove(treesaver.scheduler.tasks_,n),t.removed=!0)})},treesaver.scheduler.stopAll=function(){treesaver.scheduler.tickID_&&window.clearInterval(treesaver.scheduler.tickID_),treesaver.scheduler.resume(),treesaver.scheduler.tickID_=null,treesaver.scheduler.tasks_=[],treesaver.scheduler.namedTasks_={}},goog.provide("treesaver.debug"),goog.require("treesaver.scheduler"),treesaver.debug.messageQueue_=[],goog.DEBUG&&WITHIN_IOS_WRAPPER&&treesaver.scheduler.repeat(function(){var e=treesaver.debug.messageQueue_.pop();e&&(e=window.escape(e),document.location="ts://log/"+e)},50,Infinity),treesaver.debug.startupTime_=goog.now(),treesaver.debug.timestamp_=function(){return"["+(goog.now()-treesaver.debug.startupTime_).toFixed(3)/1e3+"s] "},treesaver.debug.info=function(e){goog.DEBUG&&window.console&&(e=treesaver.debug.timestamp_()+e,window.TS_WITHIN_NATIVE_IOS_APP?treesaver.debug.messageQueue_.push(e):"info"in window.console?window.console.info(e):window.console.log(e))},treesaver.debug.log=function(e){goog.DEBUG&&window.console&&(e=treesaver.debug.timestamp_()+e,window.TS_WITHIN_NATIVE_IOS_APP?treesaver.debug.messageQueue_.push(e):"debug"in window.console?window.console.debug(e):window.console.log(e))},treesaver.debug.warn=function(e){goog.DEBUG&&window.console&&(e=treesaver.debug.timestamp_()+e,window.TS_WITHIN_NATIVE_IOS_APP?treesaver.debug.messageQueue_.push(e):"warn"in window.console?window.console.warn(e):window.console.log(e))},treesaver.debug.error=function(e){goog.DEBUG&&window.console&&(e=treesaver.debug.timestamp_()+e,window.TS_WITHIN_NATIVE_IOS_APP?treesaver.debug.messageQueue_.push(e):"error"in window.console?window.console.error(e):window.console.log(e))},treesaver.debug.info("Running in DEBUG mode"),goog.provide("treesaver.constants");var USE_MODULES=!1,SUPPORT_LEGACY=!0,SUPPORT_MICRODATA=!0,SUPPORT_IE=!0,UI_IDLE_INTERVAL=5e3,PAGINATE_DEBOUNCE_TIME=200,SWIPE_THRESHOLD=30,SWIPE_TIME_LIMIT=2e3,MAX_ANIMATION_DURATION=200,CHECK_STATE_INTERVAL=100,MOUSE_WHEEL_INTERVAL=1500,WITHIN_IOS_WRAPPER=!1;goog.provide("treesaver.array"),goog.require("treesaver.constants"),SUPPORT_IE&&(Array.prototype.forEach||(Array.prototype.forEach=function(t){var n=0,r=this.length,i=arguments[1];for(;n<r;n+=1)n in this&&t.call(i,this[n],n,this)}),Array.prototype.some||(Array.prototype.some=function(t){var n=0,r=this.length,i=arguments[1];for(;n<r;n+=1)if(n in this&&t.call(i,this[n],n,this))return!0;return!1}),Array.prototype.every||(Array.prototype.every=function(t){var n=0,r=this.length,i=arguments[1];for(;n<r;n+=1)if(n in this&&!t.call(i,this[n],n,this))return!1;return!0}),Array.prototype.map||(Array.prototype.map=function(t){var n=0,r=this.length,i=arguments[1],s=[];for(;n<r;n+=1)n in this&&(s[n]=t.call(i,this[n],n,this));return s}),Array.prototype.filter||(Array.prototype.filter=function(t){var n=0,r,i=this.length,s=arguments[1],o=[];for(;n<i;n+=1)n in this&&(r=this[n],t.call(s,r,n,this)&&o.push(r));return o}),Array.prototype.indexOf||(Array.prototype.indexOf=function(e,t){var n,r;for(n=t||0,r=this.length;n<r;n+=1)if(this[n]===e)return n;return-1})),treesaver.array.toArray=function(e){return Array.prototype.slice.call(e,0)},treesaver.array.remove=function(e,t,n){var r=e.slice((n||t)+1||e.length);return e.length=t<0?e.length+t:t,e.push.apply(e,r)},treesaver.array.isArray=function(e){return Object.prototype.toString.apply(e)==="[object Array]"},SUPPORT_IE&&"attachEvent"in document&&(treesaver.array.toArray=function(e){var t,n,r=[];for(t=0,n=e.length;t<n;t+=1)r.push(e[t]);return r}),goog.provide("treesaver.dom"),goog.require("treesaver.array"),goog.require("treesaver.constants"),treesaver.dom.addClass=function(e,t){e.className?treesaver.dom.hasClass(e,t)||(e.className+=" "+t):e.className=t,SUPPORT_IE&&treesaver.capabilities.IS_LEGACY&&(e.className=e.className)},treesaver.dom.removeClass=function(e,t){var n=new RegExp("(^|\\s)"+t+"(\\s|$)");e.className=e.className.replace(n,"$2")},treesaver.dom.hasClass=function(e,t){var n=new RegExp("(^|\\s)"+t+"(\\s|$)");return!!e.className&&!!n.test(e.className)},treesaver.dom.classes=function(e,t){if(!e.className)return[];var n=t?e.className.toLowerCase():e.className;return n.split(/\s+/)},treesaver.dom.getElementsByClassName=function(e,t){t||(t=document);var n=[];if(!SUPPORT_LEGACY||"querySelectorAll"in t)n=treesaver.array.toArray(t.querySelectorAll("."+e));else if(SUPPORT_LEGACY){var r=t.getElementsByTagName("*"),i=new RegExp("(^|\\s)"+e+"(\\s|$)");treesaver.array.toArray(r).forEach(function(e){i.test(e.className)&&n.push(e)})}return n},treesaver.dom.getElementsByTagName=function(e,t){return t||(t=document),treesaver.array.toArray(t.getElementsByTagName(e))},treesaver.dom.getElementsByQuery=function(e,t){t=t||document;if(!SUPPORT_LEGACY||"querySelectorAll"in t)return treesaver.array.toArray(t.querySelectorAll(e));var n=[],r=treesaver.dom.getElementsByTagName("*",t),i=e.split(/,\s?/g);return r.forEach(function(e){i.forEach(function(t){(t.charAt(0)==="."&&treesaver.dom.hasClass(e,t.substr(1))||e.nodeName.toLowerCase()===t.toLowerCase())&&n.indexOf(e)===-1&&n.push(e)})}),n},treesaver.dom.getElementsByProperty=function(e,t,n,r){r||(r=document),n=n||"*";if(!SUPPORT_LEGACY||"querySelectorAll"in r){var i=n+"["+e+(t?'~="'+t+'"':"")+"]";return treesaver.array.toArray(r.querySelectorAll(i))}var s=[],o=treesaver.dom.getElementsByTagName(n,r),u=t?new RegExp("(^|\\s)"+t.replace(/[.*+?\^${}()|\[\]\/\\]/g,"\\$&")+"(\\s|$)"):{test:function(){return!0}};return e=e==="class"?"className":e,o.forEach(function(t){treesaver.dom.hasAttr(t,e)&&u.test(t.getAttribute(e))&&s.push(t)}),s},treesaver.dom.hasAttr=function(e,t){return!SUPPORT_IE||"hasAttribute"in e?e.hasAttribute(t):t==="className"?e.className!=="":e.getAttribute(t)!==null},treesaver.dom.customAttributePrefix="data-ts-",treesaver.dom.hasCustomAttr=function(e,t){return treesaver.dom.hasAttr(e,treesaver.dom.customAttributePrefix+t)},treesaver.dom.getCustomAttr=function(e,t){return e.getAttribute(treesaver.dom.customAttributePrefix+t)},treesaver.dom.clearChildren=function(e){while(e.firstChild)e.removeChild(e.firstChild)},treesaver.dom.innerText=function(e){return!SUPPORT_IE||"textContent"in e?e.textContent:e.innerText},treesaver.dom.outerHTML=function(e){if("outerHTML"in e)return e.outerHTML;var t=e.cloneNode(!0),n;return treesaver.dom.dummyDiv_.appendChild(t),n=treesaver.dom.dummyDiv_.innerHTML,treesaver.dom.dummyDiv_.removeChild(t),n},treesaver.dom.createElementFromHTML=function(e){SUPPORT_IE&&document.body.appendChild(treesaver.dom.dummyDiv_),treesaver.dom.dummyDiv_.innerHTML=e;var t=treesaver.dom.dummyDiv_.firstChild;return treesaver.dom.clearChildren(treesaver.dom.dummyDiv_),SUPPORT_IE&&document.body.removeChild(treesaver.dom.dummyDiv_),!t||t.nodeType!==1?null:t},treesaver.dom.createDocumentFragmentFromHTML=function(e){var t;SUPPORT_IE&&document.body.appendChild(treesaver.dom.dummyDiv_),treesaver.dom.dummyDiv_.innerHTML=e;if(treesaver.dom.dummyDiv_.childNodes.length===1)t=treesaver.dom.dummyDiv_.firstChild;else{t=document.createDocumentFragment();while(treesaver.dom.dummyDiv_.firstChild)t.appendChild(treesaver.dom.dummyDiv_.firstChild)}return treesaver.dom.clearChildren(treesaver.dom.dummyDiv_),SUPPORT_IE&&document.body.removeChild(treesaver.dom.dummyDiv_),!t||t.nodeType!==1&&t.nodeType!==11?null:t},"Node"in window&&Node.prototype&&!Node.prototype.contains&&(Node.prototype.contains=function(e){return!!(this.compareDocumentPosition(e)&16)}),treesaver.dom.compareDocumentPosition=function(e,t){return e.compareDocumentPosition?e.compareDocumentPosition(t):e.contains?(e!=t&&e.contains(t)&&16)+(e!=t&&t.contains(e)&&8)+(e.sourceIndex>=0&&t.sourceIndex>=0?(e.sourceIndex<t.sourceIndex&&4)+(e.sourceIndex>t.sourceIndex&&2):1)+0:0},treesaver.dom.safeInsertionPoint_=treesaver.dom.getElementsByTagName("base")[0]||treesaver.dom.getElementsByTagName("script")[0],treesaver.dom.safeAppendToDocument=function(e){treesaver.dom.safeInsertionPoint_.parentNode.insertBefore(e,treesaver.dom.safeInsertionPoint_)},treesaver.dom.dummyDiv_=document.createElement("div"),treesaver.dom.dummyDiv_.style.display="none",goog.provide("treesaver.capabilities"),goog.require("treesaver.array"),goog.require("treesaver.constants"),goog.require("treesaver.debug"),goog.require("treesaver.dom"),treesaver.capabilities.ua_=window.navigator.userAgent.toLowerCase(),treesaver.capabilities.platform_=!SUPPORT_LEGACY||window.navigator.platform?window.navigator.platform.toLowerCase():/android/.test(treesaver.capabilities.ua_)?"android":"unknown",treesaver.capabilities.IS_LEGACY=SUPPORT_LEGACY&&!("localStorage"in window&&"querySelectorAll"in document&&"JSON"in window),treesaver.capabilities.SUPPORTS_TREESAVER=!SUPPORT_LEGACY||document.compatMode!=="BackCompat"&&"XMLHttpRequest"in window&&(!!document.addEventListener||!!document.attachEvent)&&(!!document.documentElement.currentStyle||!!window.getComputedStyle)&&("querySelectorAll"in document||SUPPORT_IE&&"attachEvent"in document&&!("addEventListener"in document)),treesaver.capabilities.IS_IE8INIE7=SUPPORT_IE&&"documentMode"in document&&document.documentMode<=7,treesaver.capabilities.IS_MOBILE=WITHIN_IOS_WRAPPER||treesaver.capabilities.BROWSER_OS==="android"||/mobile/.test(treesaver.capabilities.ua_),treesaver.capabilities.IS_SMALL_SCREEN=window.screen.width<=600,treesaver.capabilities.BROWSER_NAME=function(){return WITHIN_IOS_WRAPPER?"safari":/webkit/.test(treesaver.capabilities.ua_)?/chrome|safari/.test(treesaver.capabilities.ua_)?/(chrome|safari)/.exec(treesaver.capabilities.ua_)[0]:"webkit":/opera/.test(treesaver.capabilities.ua_)?"opera":/msie/.test(treesaver.capabilities.ua_)?"msie":!/compatible/.test(treesaver.capabilities.ua_)&&/mozilla/.test(treesaver.capabilities.ua_)?"mozilla":"unknown"}(),treesaver.capabilities.BROWSER_OS=(/(android|ipad|iphone|ipod|win|mac|linux)/.exec(treesaver.capabilities.platform_)||["unknown"])[0],treesaver.capabilities.cssPrefix=function(){switch(treesaver.capabilities.BROWSER_NAME){case"chrome":case"safari":case"webkit":return"-webkit-";case"mozilla":return"-moz-";case"msie":return"-ms-";case"opera":return"-o-";default:return""}}(),treesaver.capabilities.domCSSPrefix=function(){switch(treesaver.capabilities.BROWSER_NAME){case"chrome":case"safari":case"webkit":return"Webkit";case"mozilla":return"Moz";case"msie":return"ms";case"opera":return"O";default:return""}}(),treesaver.capabilities.cssPropertySupported_=function(e,t,n){var r=document.documentElement.style,i=t&&treesaver.capabilities.domCSSPrefix?treesaver.capabilities.domCSSPrefix+e.charAt(0).toUpperCase()+e.substr(1):!1;return!n&&typeof r[e]!="undefined"||!!i&&typeof r[i]!="undefined"},treesaver.capabilities.mediaQuerySupported_=function(e,t){var n=document.createElement("style"),r=document.createElement("div"),i="ts-test",s="@media ("+e+")",o;return t&&(s+=",("+treesaver.capabilities.cssPrefix+e+")"),n.textContent=s+"{#"+i+" {height:3px}}",r.setAttribute("id",i),treesaver.dom.safeAppendToDocument(n),treesaver.dom.safeAppendToDocument(r),o=r.offsetHeight===3,n.parentNode.removeChild(n),r.parentNode.removeChild(r),o},treesaver.capabilities.SUPPORTS_ORIENTATION=WITHIN_IOS_WRAPPER||"orientation"in window,treesaver.capabilities.SUPPORTS_TOUCH=WITHIN_IOS_WRAPPER||"createTouch"in document||/android/.test(treesaver.capabilities.ua_),treesaver.capabilities.SUPPORTS_FLASH=!WITHIN_IOS_WRAPPER&&function(){if(!!window.navigator.plugins&&window.navigator.plugins.length)return!!window.navigator.plugins["Shockwave Flash"];if(SUPPORT_IE&&"ActiveXObject"in window){treesaver.debug.warn("Using ActiveX detection for Flash");try{return!!(new window.ActiveXObject("ShockwaveFlash.ShockwaveFlash.7"))}catch(e){return treesaver.debug.warn("ActiveX Flash detection failed with exception:"+e),!1}}return!1}(),treesaver.capabilities.SUPPORTS_FONTFACE=function(){return SUPPORT_LEGACY&&treesaver.capabilities.IS_LEGACY?!1:"CSSFontFaceRule"in window?!0:SUPPORT_IE&&treesaver.capabilities.BROWSER_NAME==="msie"?!0:!1}(),treesaver.capabilities.SUPPORTS_MICRODATA="getItems"in document,treesaver.capabilities.SUPPORTS_CANVAS="getContext"in document.createElement("canvas"),"createElementNS"in document?(treesaver.capabilities.SUPPORTS_SVG="createSVGRect"in document.createElementNS("http://www.w3.org/2000/svg","svg"),treesaver.capabilities.SUPPORTS_SMIL=/SVG/.test(document.createElementNS("http://www.w3.org/2000/svg","animate").toString()),treesaver.capabilities.SUPPORTS_SVGCLIPPATHS=/SVG/.test(document.createElementNS("http://www.w3.org/2000/svg","clipPath").toString())):treesaver.capabilities.SUPPORTS_SVG=treesaver.capabilities.SUPPORTS_SMIL=treesaver.capabilities.SUPPORTS_SVGCLIPPATHS=!1,treesaver.capabilities.SUPPORTS_INLINESVG=function(){var e=document.createElement("div");return e.innerHTML="<svg/>",(e.firstChild&&e.firstChild.namespaceURI)=="http://www.w3.org/2000/svg"}(),treesaver.capabilities.SUPPORTS_VIDEO="canPlayType"in document.createElement("video"),treesaver.capabilities.SUPPORTS_LOCALSTORAGE="localStorage"in window&&!treesaver.capabilities.IS_LEGACY,treesaver.capabilities.SUPPORTS_APPLICATIONCACHE=!WITHIN_IOS_WRAPPER&&"applicationCache"in window,treesaver.capabilities.SUPPORTS_CSSTRANSFORMS=WITHIN_IOS_WRAPPER||treesaver.capabilities.cssPropertySupported_("transformProperty")||treesaver.capabilities.cssPropertySupported_("transform",!0,!0),treesaver.capabilities.SUPPORTS_CSSTRANSFORMS3D=WITHIN_IOS_WRAPPER||function(){var e=treesaver.capabilities.cssPropertySupported_("perspectiveProperty")||treesaver.capabilities.cssPropertySupported_("perspective",!0,!0);return e&&"WebkitPerspective"in document.documentElement.style&&treesaver.capabilities.BROWSER_NAME!=="safari"&&(e=treesaver.capabilities.mediaQuerySupported_("perspective",!0)),e}(),treesaver.capabilities.SUPPORTS_CSSTRANSITIONS=WITHIN_IOS_WRAPPER||treesaver.capabilities.cssPropertySupported_("transitionProperty",!0),treesaver.capabilities.caps_,treesaver.capabilities.mutableCaps_,treesaver.capabilities.doPrefix_=function(e){return e?"":"no-"},treesaver.capabilities.update_=function(){var e=treesaver.capabilities.doPrefix_;treesaver.capabilities.caps_||(treesaver.capabilities.caps_=[],treesaver.capabilities.caps_.push("js",e(treesaver.capabilities.SUPPORTS_CANVAS)+"canvas",e(treesaver.capabilities.SUPPORTS_LOCALSTORAGE)+"localstorage",e(treesaver.capabilities.SUPPORTS_VIDEO)+"video",e(treesaver.capabilities.SUPPORTS_APPLICATIONCACHE)+"applicationcache",e(treesaver.capabilities.SUPPORTS_FONTFACE)+"fontface",e(treesaver.capabilities.SUPPORTS_TOUCH)+"touch",e(treesaver.capabilities.SUPPORTS_CSSTRANSFORMS)+"csstransforms",e(treesaver.capabilities.SUPPORTS_CSSTRANSFORMS3D)+"csstransforms3d",e(treesaver.capabilities.SUPPORTS_CSSTRANSITIONS)+"csstransitions",e(treesaver.capabilities.SUPPORTS_SVG)+"svg",e(treesaver.capabilities.SUPPORTS_INLINESVG)+"inlinesvg",e(treesaver.capabilities.SUPPORTS_SMIL)+"smil",e(treesaver.capabilities.SUPPORTS_SVGCLIPPATHS)+"svgclippaths",e(treesaver.capabilities.SUPPORTS_MICRODATA)+"microdata",e(treesaver.capabilities.SUPPORTS_TREESAVER)+"treesaver",e(treesaver.capabilities.SUPPORTS_FLASH)+"flash",e(treesaver.capabilities.SUPPORTS_ORIENTATION)+"orientation",e(treesaver.capabilities.IS_LEGACY)+"legacy",e(treesaver.capabilities.IS_MOBILE)+"mobile",e(treesaver.capabilities.IS_SMALL_SCREEN)+"smallscreen",e(treesaver.network.loadedFromCache())+"cached",e(WITHIN_IOS_WRAPPER)+"nativeapp","browser-"+treesaver.capabilities.BROWSER_NAME,"os-"+treesaver.capabilities.BROWSER_OS)),treesaver.capabilities.mutableCaps_=[e(!treesaver.network.isOnline())+"offline"],treesaver.capabilities.SUPPORTS_ORIENTATION&&treesaver.capabilities.mutableCaps_.push("orientation-"+(window.orientation?"horizontal":"vertical"))},treesaver.capabilities.capsFlagged_=!1,treesaver.capabilities.updateClasses=function(){treesaver.capabilities.update_();var e=document.documentElement.className;treesaver.capabilities.capsFlagged_||(treesaver.capabilities.capsFlagged_=!0,e?e=e.replace(/no-js|no-treesaver/g,""):e="",e+=" "+treesaver.capabilities.caps_.join(" "),treesaver.debug.info("Capability classes: "+e)),e=e.replace(treesaver.capabilities.mutableCapabilityRegex_,""),e+=" "+treesaver.capabilities.mutableCaps_.join(" "),document.documentElement.className=e.split(/\s+/).join(" ")},treesaver.capabilities.resetClasses=function(){document.documentElement.className="js no-treesaver"},treesaver.capabilities.mutableCapabilityList_=["offline","orientation-vertical","orientation-horizontal"],treesaver.capabilities.mutableCapabilityRegex_=function(){var e=treesaver.capabilities.mutableCapabilityList_.map(function(e){return"((no-)?"+e+")"});return new RegExp(e.join("|"))}(),treesaver.capabilities.check=function(t,n){return t.length?t.every(function(e){var t=e.substr(0,3)==="no-",r=t?e.substr(3):e,i=treesaver.capabilities.caps_.concat(n?treesaver.capabilities.mutableCaps_:[]);return t?i.indexOf(r)===-1:i.indexOf(r)!==-1?!0:!n&&treesaver.capabilities.mutableCapabilityList_.indexOf(r)!==-1?!0:!1}):!0},goog.provide("treesaver.styles"),goog.require("treesaver.capabilities"),goog.require("treesaver.constants"),goog.require("treesaver.debug"),goog.require("treesaver.dom"),treesaver.styles.insertRule=function(e,t){!SUPPORT_IE||"insertRule"in treesaver.styles.stylesheet_?treesaver.styles.stylesheet_.insertRule(e+"{"+t+"}",0):treesaver.styles.stylesheet_.addRule(e,t)},treesaver.styles.stylesheet_=document.createElement("style"),treesaver.styles.stylesheet_.setAttribute("type","text/css"),treesaver.dom.getElementsByTagName("head").length?(treesaver.dom.getElementsByTagName("head")[0].appendChild(treesaver.styles.stylesheet_),treesaver.styles.stylesheet_=document.styleSheets[document.styleSheets.length-1],treesaver.styles.insertRule(".offscreen","position:absolute;top:-200%;right:-200%;visibility:hidden;"),treesaver.styles.insertRule(".grid","top:50%"),treesaver.capabilities.SUPPORTS_CSSTRANSITIONS&&(treesaver.styles.insertRule(".grid, .scroll-container","transition:transform cubic-bezier(0,0,0.25,1) "+MAX_ANIMATION_DURATION/1e3+"s"),treesaver.capabilities.cssPrefix&&treesaver.styles.insertRule(".grid, .scroll-container",treesaver.capabilities.cssPrefix+"transition:"+treesaver.capabilities.cssPrefix+"transform cubic-bezier(0,0,0.25,1) "+MAX_ANIMATION_DURATION/1e3+"s"),treesaver.capabilities.SUPPORTS_CSSTRANSFORMS3D&&(treesaver.styles.insertRule(".grid, .scroll-container","backface-visibility:hidden"),treesaver.capabilities.cssPrefix&&treesaver.styles.insertRule(".grid, .scroll-container",treesaver.capabilities.cssPrefix+"backface-visibility:hidden")))):treesaver.debug.error("No head to put default stylesheet into"),goog.provide("treesaver.css"),treesaver.css.getStyleObject=function(e){return document.defaultView.getComputedStyle(e,null)},SUPPORT_IE&&(!document.defaultView||!document.defaultView.getComputedStyle)&&(treesaver.css.getStyleObject=function(e){return e.currentStyle}),goog.provide("treesaver.dimensions"),goog.require("treesaver.capabilities"),goog.require("treesaver.css"),goog.require("treesaver.constants"),treesaver.dimensions.Size,treesaver.dimensions.SizeRange,treesaver.dimensions.pixel=/^-?\d+(?:px)?$/i,treesaver.dimensions.number=/^-?\d/,treesaver.dimensions.inSizeRange=function(e,t){if(!e)return!1;var n=e.minW||e.minW===0?e.minW:e.w,r=e.minH||e.minH===0?e.minH:e.h;return t.w>=n&&t.h>=r&&t.w<=e.maxW&&t.h<=e.maxH},treesaver.dimensions.mergeSizeRange=function(e,t,n){e=e||{},t=t||{};var r=n?t.bpHeight||(t.outerH?t.outerH-t.h:0):0,i=n?t.bpWidth||(t.outerW?t.outerW-t.w:0):0;return{w:Math.max(e.w||0,t.w+i||0),h:Math.max(e.h||0,t.h+r||0),maxW:Math.min(e.maxW||Infinity,t.maxW+i||Infinity),maxH:Math.min(e.maxH||Infinity,t.maxH+r||Infinity)}},treesaver.dimensions.toPixels=function(e,t){return t&&treesaver.dimensions.pixel.test(t)?parseFloat(t)||0:null},treesaver.dimensions.getSize=function(e){return{w:treesaver.dimensions.getOffsetWidth(e),h:treesaver.dimensions.getOffsetHeight(e)}},treesaver.dimensions.getOffsetHeight=function(e){return e&&e.offsetHeight||0},treesaver.dimensions.getOffsetWidth=function(e){return e&&e.offsetWidth||0},treesaver.dimensions.getOffsetTop=function(e){return e&&e.offsetTop||0},treesaver.dimensions.getBoundingClientRect=function(e){if(!e)return{};var t=e.getBoundingClientRect(),n,r;if(!("height"in t)){n=t,t={};for(r in n)t[r]=n[r];t.height=t.bottom-t.top,t.width=t.right-t.left}return t},SUPPORT_IE&&(!document.defaultView||!document.defaultView.getComputedStyle)&&(treesaver.capabilities.IS_LEGACY&&(treesaver.dimensions.getOffsetTop=function(e){return e?(e.style.zoom=1,e.offsetTop):0},treesaver.dimensions.getOffsetHeight=function(e){return e?(e.style.zoom=1,e.offsetHeight):0},treesaver.dimensions
.getOffsetWidth=function(e){return e?(e.style.zoom=1,e.offsetWidth):0}),treesaver.dimensions.toPixels=function(e,t){var n,r,i;return t&&treesaver.dimensions.pixel.test(t)?parseFloat(t):t&&treesaver.dimensions.number.test(t)?(n=e.style.left,r=e.runtimeStyle.left,e.runtimeStyle.left=e.currentStyle.left,e.style.left=t||0,i=e.style.pixelLeft,e.style.left=n,e.runtimeStyle.left=r,i):null}),treesaver.dimensions.setCssPx=function(e,t,n){return e.style[t]=n+"px",n},treesaver.dimensions.setOffset,treesaver.dimensions.setOffsetX,treesaver.capabilities.SUPPORTS_CSSTRANSFORMS?(treesaver.dimensions.setTransformProperty_=function(e,t){"transformProperty"in e.style?e.style.transformProperty=t:e.style[treesaver.capabilities.domCSSPrefix+"Transform"]=t},treesaver.capabilities.SUPPORTS_CSSTRANSFORMS3D?treesaver.dimensions.setOffset=function(e,t,n){treesaver.dimensions.setTransformProperty_(e,"translate3d("+t+"px,"+n+"px,0)")}:treesaver.dimensions.setOffset=function(e,t,n){treesaver.dimensions.setTransformProperty_(e,"translate("+t+"px,"+n+"px)")},treesaver.dimensions.setOffsetX=function(e,t){treesaver.dimensions.setOffset(e,t,0)}):(treesaver.dimensions.setOffset=function(e,t,n){treesaver.dimensions.setCssPx(e,"left",t),treesaver.dimensions.setCssPx(e,"top",n)},treesaver.dimensions.setOffsetX=function(e,t){treesaver.dimensions.setCssPx(e,"left",t)}),treesaver.dimensions.roundUp=function(e,t){return Math.ceil(e)+t-e%t},treesaver.dimensions.Metrics=function(e){if(!e)return;var t=treesaver.css.getStyleObject(e),n=e.style.position,r=e.getAttribute("style"),i;this.display=t.display,this.position=t.position,SUPPORT_IE&&treesaver.capabilities.IS_LEGACY&&(e.style.zoom=1),this.marginTop=treesaver.dimensions.toPixels(e,t.marginTop)||0,this.marginBottom=treesaver.dimensions.toPixels(e,t.marginBottom)||0,this.marginLeft=treesaver.dimensions.toPixels(e,t.marginLeft)||0,this.marginRight=treesaver.dimensions.toPixels(e,t.marginRight)||0,this.marginHeight=this.marginTop+this.marginBottom,this.marginWidth=this.marginLeft+this.marginRight,this.borderTop=treesaver.dimensions.toPixels(e,t.borderTopWidth),this.borderBottom=treesaver.dimensions.toPixels(e,t.borderBottomWidth),this.borderLeft=treesaver.dimensions.toPixels(e,t.borderLeftWidth),this.borderRight=treesaver.dimensions.toPixels(e,t.borderRightWidth),this.paddingTop=treesaver.dimensions.toPixels(e,t.paddingTop),this.paddingBottom=treesaver.dimensions.toPixels(e,t.paddingBottom),this.paddingLeft=treesaver.dimensions.toPixels(e,t.paddingLeft),this.paddingRight=treesaver.dimensions.toPixels(e,t.paddingRight),this.bpTop=this.borderTop+this.paddingTop,this.bpBottom=this.borderBottom+this.paddingBottom,this.bpHeight=this.bpTop+this.bpBottom,this.bpLeft=this.borderLeft+this.paddingLeft,this.bpRight=this.borderRight+this.paddingRight,this.bpWidth=this.bpLeft+this.bpRight,this.outerW=treesaver.dimensions.getOffsetWidth(e),this.outerH=treesaver.dimensions.getOffsetHeight(e),this.w=this.outerW-this.bpWidth,this.h=this.outerH-this.bpHeight,this.minW=treesaver.dimensions.toPixels(e,t.minWidth)||0,this.minH=treesaver.dimensions.toPixels(e,t.minHeight)||0,i=treesaver.dimensions.toPixels(e,t.maxWidth),this.maxW=!i||i===-1?Infinity:i,i=treesaver.dimensions.toPixels(e,t.maxHeight),this.maxH=!i||i===-1?Infinity:i,this.lineHeight=treesaver.dimensions.toPixels(e,t.lineHeight)||null},treesaver.dimensions.Metrics.prototype.clone=function(){var e=new treesaver.dimensions.Metrics,t;for(t in this)e[t]!==this[t]&&(e[t]=this[t]);return e},goog.DEBUG&&(treesaver.dimensions.Metrics.prototype.toString=function(){return"[Metrics: "+this.w+"x"+this.h+"]"}),goog.provide("treesaver.events"),goog.require("treesaver.array"),goog.require("treesaver.constants"),goog.require("treesaver.debug"),treesaver.events.fireEvent=function(e,t,n){var r=document.createEvent("UIEvents"),i,s;r.initEvent(t,!1,!0);if(n)for(i in n)r[i]=n[i];return e.dispatchEvent(r)},treesaver.events.addListener=function(e,t,n){if(goog.DEBUG)try{e.addEventListener(t,n,!1)}catch(r){treesaver.debug.error("Could not add "+t+" listener to: "+e),treesaver.debug.error("Exception "+r)}else e.addEventListener(t,n,!1)},treesaver.events.removeListener=function(e,t,n){if(goog.DEBUG)try{e.removeEventListener(t,n,!1)}catch(r){treesaver.debug.error("Could not remove "+t+" listener from: "+e),treesaver.debug.error("Exception "+r)}else e.removeEventListener(t,n,!1)};if(SUPPORT_IE&&!("addEventListener"in document)){treesaver.debug.warn("Using IE event model");var IE_NATIVE_EVENTS=["abort","activate","afterprint","afterupdate","beforeactivate","beforecopy","beforecut","beforedeactivate","beforeeditfocus","beforepaste","beforeprint","beforeunload","beforeupdate","blur","bounce","cellchange","change","click","contextmenu","controlselect","copy","cut","dataavailable","datasetchanged","datasetcomplete","dblclick","deactivate","drag","dragend","dragenter","dragleave","dragover","dragstart","drop","error","error","errorupdate","filterchange","finish","focus","focusin","focusout","hashchange","help","keydown","keypress","keyup","layoutcomplete","load","losecapture","message","mousedown","mouseenter","mouseleave","mousemove","mouseout","mouseover","mouseup","mousewheel","move","moveend","movestart","offline","online","page","paste","progress","propertychange","readystatechange","readystatechange","reset","resize","resizeend","resizestart","rowenter","rowexit","rowsdelete","rowsinserted","scroll","select","selectionchange","selectstart","start","stop","storage","storagecommit","submit","timeout","unload"];treesaver.events.preventDefault=function(){this.returnValue=!1},treesaver.events.stopPropagation=function(){this.cancelBubble=!0},treesaver.events.fireEvent=function(e,t,n){var r=document.createEventObject(),i;r.type=t;if(n)for(i in n)r[i]=n[i];r.preventDefault||(r.preventDefault=treesaver.events.preventDefault),r.stopPropagation||(r.stopPropagation=treesaver.events.stopPropagation);try{return e.fireEvent("on"+t,r)}catch(s){}return e.custom_handlers&&e.custom_handlers[t]&&e.custom_handlers[t].master(r),!1},treesaver.events.createMasterHandler_=function(e,t){return function(n){n=n||window.event,n.target=n.target||n.srcElement,n.preventDefault=treesaver.events.preventDefault,n.stopPropagation=treesaver.events.stopPropagation,e.custom_handlers[t].handlers.forEach(function(r){try{"handleEvent"in r?r.handleEvent(n):r.call(e,n)}catch(i){treesaver.debug.error("Exception during "+t+" handler: "+i)}})}},treesaver.events.addListener=function(e,t,n){e.custom_handlers||(e.custom_handlers={}),e.custom_handlers[t]||(e.custom_handlers[t]={handlers:[],master:treesaver.events.createMasterHandler_(e,t)},IE_NATIVE_EVENTS.indexOf(t)!==-1&&e.attachEvent("on"+t,e.custom_handlers[t].master)),e.custom_handlers[t].handlers.push(n)},treesaver.events.removeListener=function(e,t,n){if(e.custom_handlers&&e.custom_handlers[t]){var r=e.custom_handlers[t].handlers.indexOf(n);r!==-1&&treesaver.array.remove(e.custom_handlers[t].handlers,r),e.custom_handlers[t].handlers.length||(IE_NATIVE_EVENTS.indexOf(t)!==-1&&e.detachEvent("on"+t,e.custom_handlers[t].master),e.custom_handlers[t]=null)}}}goog.exportSymbol("treesaver.addListener",treesaver.events.addListener),goog.exportSymbol("treesaver.removeListener",treesaver.events.removeListener),goog.provide("treesaver.layout.ContentPosition"),treesaver.layout.ContentPosition=function(e,t,n){this.block=e,this.figure=t,this.overhang=n},treesaver.layout.ContentPosition.END=new treesaver.layout.ContentPosition(Infinity,Infinity,Infinity),treesaver.layout.ContentPosition.prototype.atBeginning=function(){return!this.block&&!this.figure&&!this.overhang},treesaver.layout.ContentPosition.sort=function(e,t){return e.block!==t.block?t.block-e.block:e.overhang!==t.overhang?e.overhang-t.overhang:t.figure-e.figure},treesaver.layout.ContentPosition.prototype.lessOrEqual=function(e){return treesaver.layout.ContentPosition.sort(this,e)>=0},treesaver.layout.ContentPosition.prototype.greater=function(e){return treesaver.layout.ContentPosition.sort(this,e)<0},treesaver.layout.ContentPosition.prototype.clone=function(){return new this.constructor(this.block,this.figure,this.overhang)},goog.provide("treesaver.layout.BreakRecord"),goog.require("treesaver.layout.ContentPosition"),treesaver.layout.BreakRecord=function(){this.index=0,this.figureIndex=0,this.overhang=0,this.finished=!1,this.delayed=[],this.failed=[],this.pageNumber=0},treesaver.layout.BreakRecord.prototype.clone=function(){var e=new this.constructor;return e.index=this.index,e.figureIndex=this.figureIndex,e.overhang=this.overhang,e.finished=this.finished,e.delayed=this.delayed.slice(0),e.failed=this.failed.slice(0),e.pageNumber=this.pageNumber,e},treesaver.layout.BreakRecord.prototype.equals=function(e){return!!e&&e.index===this.index&&e.figureIndex===this.figureIndex&&e.overhang===this.overhang&&e.delayed.length===this.delayed.length},treesaver.layout.BreakRecord.prototype.getPosition=function(){return new treesaver.layout.ContentPosition(this.index,this.figureIndex,this.overhang)},treesaver.layout.BreakRecord.prototype.atStart=function(){return!this.index&&!this.figureIndex&&!this.overhang},treesaver.layout.BreakRecord.prototype.atEnd=function(e){if(this.overhang)return!1;var t,n,r;for(t=this.index,n=e.blocks.length;t<n;t+=1){r=e.blocks[t];if(!r.isFallback)return!1;if(!this.figureUsed(t)&&!r.figure.optional)return!1}if(!this.delayed.length&&this.figureIndex===e.figures.length)return!0;var t,n,i,s=this.delayed.slice(0);while(s.length){i=e.figures[s.pop()];if(!i.optional)return!1}for(t=this.figureIndex,n=e.figures.length;t<n;t+=1){i=e.figures[t];if(!i.optional)return!1}return!0},treesaver.layout.BreakRecord.prototype.useFigure=function(e){var t;e<0&&treesaver.debug.error("Negative number passed to useFigure");if(e<this.figureIndex)(t=this.delayed.indexOf(e))!==-1?treesaver.array.remove(this.delayed,t):(t=this.failed.indexOf(e))!==-1&&treesaver.array.remove(this.failed,t);else{if(e>this.figureIndex)for(;this.figureIndex<e;this.figureIndex+=1)this.delayed.push(this.figureIndex);this.figureIndex=e+1}},treesaver.layout.BreakRecord.prototype.delayFigure=function(e){this.delayed.indexOf(e)===-1&&(this.useFigure(e),this.delayed.push(e))},treesaver.layout.BreakRecord.prototype.figureUsed=function(e){return this.figureIndex<=e?!1:this.delayed.indexOf(e)!==-1?!1:this.failed.indexOf(e)!==-1?!1:!0},treesaver.layout.BreakRecord.prototype.failedFigure=function(e){this.useFigure(e),this.failed.push(e)},goog.DEBUG&&(treesaver.layout.BreakRecord.prototype.toString=function(){return"[BreakRecord "+this.index+"/"+this.figureIndex+"]"}),goog.provide("treesaver.layout.FigureSize"),goog.require("treesaver.dom"),treesaver.layout.FigureSize=function(e,t,n,r){this.html=e,this.minW=parseInt(t||0,10),this.minH=parseInt(n||0,10),this.requirements=r},treesaver.layout.FigureSize.prototype.meetsRequirements=function(){return this.requirements?treesaver.capabilities.check(this.requirements,!0):!0},treesaver.layout.FigureSize.prototype.applySize=function(e,t){t&&treesaver.dom.addClass(e,t),e.innerHTML=this.html,treesaver.dom.getElementsByProperty("data-src",null,"img",e).forEach(function(e){e.setAttribute("src",e.getAttribute("data-src"))})},treesaver.layout.FigureSize.prototype.revertSize=function(e,t){treesaver.dom.removeClass(e,t),treesaver.dom.clearChildren(e)},goog.DEBUG&&(treesaver.layout.FigureSize.prototype.toString=function(){return"[FigureSize: "+this.index+"/"+this.html+"]"}),goog.provide("treesaver.string"),String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^\s\s*/,"").replace(/\s\s*$/,"")}),goog.provide("treesaver.object"),treesaver.object.keys=function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(n);return t},treesaver.object.isObject=function(e){return Object.prototype.toString.apply(e)==="[object Object]"},Object.clone=function(e){function t(){}return t.prototype=e,new t},goog.provide("treesaver.template"),goog.require("treesaver.array"),goog.require("treesaver.dom"),goog.require("treesaver.object"),goog.require("treesaver.string"),treesaver.template.expand=function(e,t){treesaver.template.expandObject_(e,t)},treesaver.template.expandObject_=function(e,t){var n={},r=[],i=[],s,o,u,a;r=treesaver.dom.getElementsByProperty("data-bind",null,null,t);for(s=0,u=r.length;s<u;s+=1){a=!1;for(o=0;o<u;o+=1)if(r[s]!==r[o]&&r[o].contains(r[s])){a=!0;break}a||i.push(r[s])}treesaver.dom.hasAttr(t,"data-bind")&&i.push(t),i.forEach(function(t){var n=t.getAttribute("data-bind").split(/\s+/);n.forEach(function(n){var r=n.indexOf(":"),i=null,s=null,o=null,u=[],a=null,f="";r!==-1?(i=n.substring(0,r),s=n.substring(r+1)):i=n;if(e[i]){o=e[i];if(treesaver.array.isArray(o))u=treesaver.array.toArray(t.childNodes),o.forEach(function(e){u.forEach(function(n){var r=n.cloneNode(!0);r.nodeType===1&&treesaver.template.expand(e,r),t.appendChild(r)})}),u.forEach(function(e){t.removeChild(e)});else if(treesaver.object.isObject(o))u=treesaver.array.toArray(t.childNodes),u.forEach(function(e){e.nodeType===1&&treesaver.template.expand(o,e)});else{if(s!==null){if(s!=="href"&&s!=="src"||!treesaver.dom.hasAttr(t,"data-"+s))s==="class"?f=t.className:f=t.getAttribute(s);else if(!treesaver.dom.hasAttr(t,s)||!/{{[^}]+}}/.test(f=t.getAttribute(s)))f=t.getAttribute("data-"+s)}else f=t.innerHTML;o||(o=""),o=o.toString(),f&&/{{[^}]+}}/.test(f)?f=f.replace(/{{([^}]+)}}/g,function(e,t){return t=t.trim(),t===i?s===null||s!=="href"&&s!=="src"?s?o:treesaver.template.escapeHTML(o):encodeURIComponent(o):"{{"+t+"}}"}):f=treesaver.template.escapeHTML(o),s?s==="class"?t.className=f:t.setAttribute(s,f):t.innerHTML=f}}})})},treesaver.template.hasBindName=function(e,t){var n=e.getAttribute("data-bind").split(/\s+/);return n.some(function(e){var n=e.indexOf(":");return n!==-1?e.substring(0,n)===t:e===t})},treesaver.template.getElementsByBindName=function(e,t,n){var r=treesaver.dom.getElementsByProperty("data-bind",null,t,n);return r.filter(function(t){return treesaver.template.hasBindName(t,e)})},treesaver.template.escapeHTML=function(e){return e.replace(/&(?!\w+;)|[<>]/g,function(e){switch(e){case"&":return"&amp;";case"<":return"&lt;";case">":return"&gt;";default:return e}})},goog.provide("treesaver.layout.Figure"),goog.require("treesaver.array"),goog.require("treesaver.capabilities"),goog.require("treesaver.dom"),goog.require("treesaver.layout.FigureSize"),goog.require("treesaver.string"),goog.require("treesaver.template"),treesaver.layout.Figure=function(e,t,n){this.anchorIndex=n.index,this.figureIndex=n.figureIndex,n.figureIndex+=1,this.fallback=null,this.sizes={},this.optional=!treesaver.dom.hasClass(e,"required"),this.zoomable=treesaver.dom.hasClass(e,"zoomable"),this.templates=[],treesaver.array.toArray(e.childNodes).forEach(function(e){if(e.nodeType!==1){e.data&&e.data.trim()&&treesaver.debug.info("textNode ignored in figure: "+e.data);return}this.processElement(e)},this),this.sizes.fallback&&(this.processFallback(this.sizes.fallback[0].html,e,t,n),delete this.sizes.fallback),delete this.templates},treesaver.layout.Figure.prototype.processFallback=function(t,n,r,i){var s=n.parentNode,o=document.createElement("div"),u;o.innerHTML=t,o.childNodes.length===1?u=o.firstChild:u=o,u=u,s.insertBefore(u,n),this.zoomable&&(treesaver.dom.addClass(u,"zoomable"),u.setAttribute("data-figureindex",this.figureIndex),(WITHIN_IOS_WRAPPER||treesaver.capabilities.SUPPORTS_TOUCH)&&u.setAttribute("onclick","void(0)")),treesaver.layout.Block.sanitizeNode(u,r),this.fallback=new treesaver.layout.Block(u,r,i,!0),this.fallback.figure=this,this.fallback.blocks&&this.fallback.blocks.forEach(function(e){e.figure=this,e.withinFallback=!0},this),s.removeChild(u)},treesaver.layout.Figure.prototype.getSize=function(e){var t,n;if(this.sizes[e])for(t=0,n=this.sizes[e].length;t<n;t+=1)if(this.sizes[e][t].meetsRequirements())return this.sizes[e][t];return null},treesaver.layout.Figure.prototype.getLargestSize=function(e){var t=-Infinity,n=-Infinity,r,i;for(i in this.sizes)this.sizes[i].forEach(function(s){if(!s.meetsRequirements())return;if(s.minW&&s.minW>e.w||s.minH&&s.minH>e.h)return;(!s.minW||s.minW>=t)&&(!s.minH||s.minH>=n)&&(t=s.minW,n=s.minH,r={name:i,figureSize:s})});return r},treesaver.layout.Figure.prototype.saveSizes=function(t,n,r,i,s){var o=new treesaver.layout.FigureSize(n,r,i,s);t.forEach(function(e){this.sizes[e]?this.sizes[e].push(o):this.sizes[e]=[o]},this)},treesaver.layout.Figure.prototype.processElement=function(t){var n=t.getAttribute("data-sizes"),r=parseInt(t.getAttribute(treesaver.dom.hasAttr(t,"width")?"width":"data-minwidth"),10),i=parseInt(t.getAttribute(treesaver.dom.hasAttr(t,"height")?"height":"data-minheight"),10),s=treesaver.dom.hasAttr(t,"data-requires")?t.getAttribute("data-requires").split(" "):null,o;if(s&&!treesaver.capabilities.check(s))return;t.removeAttribute("hidden"),treesaver.dom.removeClass(t,"hidden"),o=treesaver.dom.outerHTML(t),n?n=n.split(" "):n=["fallback"],this.saveSizes(n,o,r,i,s)},treesaver.layout.Figure.isFigure=function(t){var n=t.nodeName.toLowerCase();return t.nodeType===1&&n==="figure"},goog.DEBUG&&(treesaver.layout.Figure.prototype.toString=function toString(){return"[Figure: "+this.index+"/"+this.figureIndex+"]"}),goog.provide("treesaver.layout.Block"),goog.require("treesaver.array"),goog.require("treesaver.debug"),goog.require("treesaver.dimensions"),goog.require("treesaver.dom"),goog.require("treesaver.layout.Figure"),treesaver.layout.Block=function(e,t,n,r){var i=treesaver.layout.Block.isReplacedElement(e),s,o,u="",a,f;goog.DEBUG&&(n||(treesaver.debug.warn("Autogen indices. Will not work in production!"),n={index:0,figureIndex:0}));if(e.nodeType!==1){treesaver.debug.error("Non-element sent into Block constructor: "+e),this.ignore=!0;return}e=e;if(!treesaver.dimensions.getOffsetHeight(e)){treesaver.debug.warn("Zero-height block ignored"),this.ignore=!0;return}this.index=n.index,n.index+=1,this.hasBlockChildren=!i&&treesaver.layout.Block.hasBlockChildren(e),this.isFallback=!1,this.withinFallback=!1,this.containsFallback=!1,this.figure=null,this.blocks=[],this.figures=[],s=!1,this.hasBlockChildren&&!treesaver.dom.hasClass(e,"keeptogether")&&(treesaver.layout.Block.processChildren(this,e,t,n,r),s=!!this.figures.length,this.hasBlockChildren=!!this.blocks.length),this.breakable=this.breakable||!i,this.keepwithnext=treesaver.dom.hasClass(e,"keepwithnext"),this.columnBreak=treesaver.dom.hasClass(e,"columnbreak"),this.keeptogether=this.keeptogether||!this.breakable||treesaver.dom.hasClass(e,"keeptogether"),this.metrics=new treesaver.dimensions.Metrics(e),this.metrics.lineHeight||(this.metrics.lineHeight=t),this.keeptogether||(this.keeptogether=this.metrics.bpHeight+this.metrics.lineHeight===this.metrics.outerH),this.firstLine=this.keeptogether?this.metrics.outerH:this.hasBlockChildren?this.containsFallback?this.metrics.bpTop+this.blocks[0].firstLine:this.metrics.bpTop+this.blocks[0].firstLine+(this.metrics.bpTop?this.blocks[0].metrics.marginTop:0):this.metrics.bpTop+this.metrics.lineHeight,goog.DEBUG&&(e.setAttribute("data-index",this.index),e.setAttribute("data-outerHeight",this.metrics.outerH),e.setAttribute("data-marginTop",this.metrics.marginTop),e.setAttribute("data-marginBottom",this.metrics.marginBottom),e.setAttribute("data-firstLine",this.firstLine)),this.html=treesaver.dom.outerHTML(e),this.openTag=this.hasBlockChildren?this.html.substr(0,this.html.indexOf(">")+1):null,this.closeTag=this.hasBlockChildren?this.html.slice(this.html.lastIndexOf("<")):null,s&&(this.html=this.openTag,this.blocks.forEach(function(e){this.html+=e.html},this),this.html+=this.closeTag),this.hasBlockChildren&&(f=e.cloneNode(!0),this.metrics.marginTop&&treesaver.dimensions.setCssPx(f,"marginTop",0),this.metrics.borderTop&&treesaver.dimensions.setCssPx(f,"borderTopWidth",0),this.metrics.paddingTop&&treesaver.dimensions.setCssPx(f,"paddingTop",0),u=treesaver.dom.outerHTML(f)),this.openTag_zero=this.hasBlockChildren?u.substr(0,u.indexOf(">")+1):null},treesaver.layout.Block.prototype.getNextNonChildBlock=function(){return this.nextSibling?this.nextSibling:this.parent?this.parent.getNextNonChildBlock():null},treesaver.layout.Block.processChildren=function(e,t,n,r,i){var s,o=e instanceof treesaver.layout.Block,u=t.nodeName.toLowerCase()==="ol"&&"start"in t,a=u?t.start:null;a===-1&&(a=1),treesaver.array.toArray(t.childNodes).forEach(function(t){var f;u&&t.nodeName.toLowerCase()==="li"&&(t.value&&t.value!==-1&&(a=t.value),t.setAttribute("value",a),a+=1);if(treesaver.layout.Figure.isFigure(t)){if(i){treesaver.debug.warn("Child figure ignored");return}f=new treesaver.layout.Figure(t,n,r),e.figures.push(f);if(f=f.fallback)f.isFallback=!0,o&&(e.containsFallback=!0)}else f=new treesaver.layout.Block(t,n,r,!!i),o&&!e.containsFallback&&(e.containsFallback=f.containsFallback);f&&!f.ignore&&(e.blocks=e.blocks.concat(f,f.blocks||[]),f.figures.length&&(e.figures=e.figures.concat(f.figures),delete f.figures),f.parent=o?e:null,s&&(s.nextSibling=f),s=f)})},treesaver.layout.Block.prototype.openAllTags=function(e){var t=this.parent,n=[];while(t)n.unshift(e?t.openTag_zero:t.openTag),t=t.parent;return n.join("")},treesaver.layout.Block.prototype.closeAllTags=function(){var e=this.parent,t=[];while(e)t.push(e.closeTag),e=e.parent;return t.join("")},treesaver.layout.Block.prototype.totalBpBottom=function(){var e=this,t=e.metrics.bpBottom;while(e=e.parent)t+=e.metrics.bpBottom;return t},treesaver.layout.Block.hasBlockChildren=function(e){if(treesaver.layout.Block.isInlineContainer(e))return!1;if(treesaver.layout.Block.isBlockContainer(e))return!0;var t,n,r,i,s=!1;for(t=0,n=e.childNodes.length;t<n;t+=1){r=e.childNodes[t];if(r.nodeType===3&&/[^\s]/.test(r.data))return!1;if(r.nodeType===1){if(treesaver.layout.Block.isInlineContainer(r)||treesaver.layout.Block.isBlockContainer(r))return!0;s=!0,i=treesaver.css.getStyleObject(r);if(/inline/.test(i.display))return!1;if(/block/.test(i.display))return!0}}return s},treesaver.layout.Block.replaced_elements=["img","video","object","embed","iframe","audio","canvas","svg","table"],treesaver.layout.Block.isReplacedElement=function(e){var t=e.nodeName.toLowerCase();return e.nodeType===1&&treesaver.layout.Block.replaced_elements.indexOf(t)!==-1},treesaver.layout.Block.inline_containers=["p","h1","h2","h3","h4","h5","h6"],treesaver.layout.Block.isInlineContainer=function(e){var t=e.nodeName.toLowerCase();return e.nodeType===1&&treesaver.layout.Block.inline_containers.indexOf(t)!==-1},treesaver.layout.Block.block_containers=["div","article","ul","ol","figure","aside"],treesaver.layout.Block.isBlockContainer=function(e){var t=e.nodeName.toLowerCase();return e.nodeType===1&&treesaver.layout.Block.block_containers.indexOf(t)!==-1},treesaver.layout.Block.sanitizeNode=function(e,t){if(e.nodeType!==1)return treesaver.debug.error("Text node sent to sanitize: "+e),e;var n,r;e=e,e.removeAttribute("id");if(treesaver.layout.Figure.isFigure(e))return e;if(treesaver.layout.Block.hasBlockChildren(e)&&!treesaver.dom.hasClass(e,"keeptogether"))for(n=e.childNodes.length-1;n>=0;n-=1)r=e.childNodes[n],r.nodeType!==1?e.removeChild(r):treesaver.layout.Block.sanitizeNode(r,t);return window.TS_NO_AUTOMETRICS||treesaver.layout.Block.normalizeMetrics_(e,t),e},treesaver.layout.Block.normalizeMetrics_=function(e,t){t||treesaver.debug.error("No line height provided to normalizeMetrics_");var n=new treesaver.dimensions.Metrics(e);return n.marginTop%t&&treesaver.dimensions.setCssPx(e,"marginTop",treesaver.dimensions.roundUp(n.marginTop,t)),n.marginBottom%t&&treesaver.dimensions.setCssPx(e,"marginBottom",treesaver.dimensions.roundUp(n.marginBottom,t)),treesaver.layout.Block.isReplacedElement(e)||treesaver.dom.hasClass(e,"keeptogether")?(n.outerH%t&&treesaver.dimensions.setCssPx(e,"paddingBottom",n.paddingBottom+t-n.outerH%t),e):(n.lineHeight?n.lineHeight%t&&treesaver.dimensions.setCssPx(e,"lineHeight",treesaver.dimensions.roundUp(n.lineHeight,t)):(n.lineHeight=t,treesaver.dimensions.setCssPx(e,"lineHeight",t)),n.bpTop%t&&treesaver.dimensions.setCssPx(e,"paddingTop",treesaver.dimensions.roundUp(n.bpTop,t)-n.borderTop),n.bpBottom%t&&(n.paddingBottom=treesaver.dimensions.setCssPx(e,"paddingBottom",treesaver.dimensions.roundUp(n.bpBottom,t)-n.borderBottom)),n.outerH=treesaver.dimensions.getOffsetHeight(e),n.outerH%t&&(treesaver.debug.info("Forcing padding due to mismatch: "+e),n.paddingBottom+=t-n.outerH%t,treesaver.dimensions.setCssPx(e,"paddingBottom",n.paddingBottom)),e)},goog.DEBUG&&(treesaver.layout.Block.prototype.toString=function(){return"[Block: "+this.metrics.outerH+"/"+this.metrics.lineHeight+"]"}),goog.provide("treesaver.layout.Content"),goog.require("treesaver.css"),goog.require("treesaver.debug"),goog.require("treesaver.dimensions"),goog.require("treesaver.dom"),goog.require("treesaver.layout.Block"),treesaver.layout.Content=function(e){var t={index:0,figureIndex:0};this.lineHeight=treesaver.dimensions.toPixels(e,treesaver.css.getStyleObject(e).lineHeight)||1,this.colWidth=e.offsetWidth,treesaver.dom.getElementsByTagName("figure",e).forEach(function(e){e.style.display="none"}),treesaver.layout.Block.sanitizeNode(e,this.lineHeight),this.figures=[],this.blocks=[],treesaver.layout.Block.processChildren(this,e,this.lineHeight,t),this.fields={},treesaver.microdata.getJSONItems(null,e).forEach(function(e){var t=treesaver.microdata.normalizeItem(e),n=treesaver.object.keys(t);n.forEach(function(e){this.fields[e]||(this.fields[e]=t[e],treesaver.debug.info("Field found --- "+e+": "+t[e].toString()))},this)},this)},goog.DEBUG&&(treesaver.layout.Content.prototype.toString=function(){return"[Content]"}),goog.provide("treesaver.layout.Column"),goog.require("treesaver.dimensions"),goog.require("treesaver.dom"),treesaver.layout.Column=function(e,t){var n=new treesaver.dimensions.Metrics(e);this.flexible=!treesaver.dom.hasClass(e,"fixed"),this.minH=n.minH,this.minH&&treesaver.dimensions.setCssPx(e,"minHeight",0),this.h=n.outerH,this.delta=Math.max(0,t-this.h)},treesaver.layout.Column.prototype.stretch=function(t){return this.flexible?(this.h=Math.max(0,t-this.delta),this):this},goog.DEBUG&&(treesaver.layout.Column.prototype.toString=function toString(){return"[Column "+this.h+"/"+this.delta+"]"}),goog.provide("treesaver.layout.Container"),goog.require("treesaver.dimensions"),goog.require("treesaver.dom"),treesaver.layout.Container=function(e,t){var n=new treesaver.dimensions.Metrics(e);this.flexible=!treesaver.dom.hasClass(e,"fixed"),this.minH=n.minH,this.minH&&treesaver.dimensions.setCssPx(e,"minHeight",0),this.h=n.outerH,this.delta=Math.max(0,t-this.h);var r=e.getAttribute("data-sizes");this.sizes=r?r.split(" "):[]},treesaver.layout.Container.prototype.stretch=function(t){return this.flexible?(this.h=Math.max(0,t-this.delta),this):this},goog.DEBUG&&(treesaver.layout.Container.prototype.toString=function toString(){return"[Container "+this.h+"/"+this.delta+"]"}),goog.provide("treesaver.layout.Grid"),goog.require("treesaver.array"),goog.require("treesaver.capabilities"),goog.require("treesaver.debug"),goog.require("treesaver.dom"),goog.require("treesaver.dimensions"),goog.require("treesaver.layout.Block"),goog.require("treesaver.layout.BreakRecord"),goog.require("treesaver.layout.Column"),goog.require("treesaver.layout.Container"),goog.require("treesaver.layout.Figure"),treesaver.layout.Grid=function(e){goog.DEBUG&&(!e||!treesaver.dom.hasClass(e,"grid"))&&treesaver.debug.error("Non grid passed to initGrid"),document.body.appendChild(e),this.requirements=treesaver.dom.hasAttr(e,"data-requires")?e.getAttribute("data-requires").split(" "):null,this.classes=treesaver.dom.classes(e,!0),this.flexible=!treesaver.dom.hasClass(e,"fixed"),this.scoringFlags,this.pageNumberFlags,this.pageNumberNegationFlags,this.findScoringFlags(),this.stretchedSize=this.size=new treesaver.dimensions.Metrics(e),this.flexible?this.size.minW=Math.max(this.size.minW||0,this.size.w):(this.size.minH=this.size.h,this.size.minW=this.size.w),this.lineHeight=this.size.lineHeight||1,this.textHeight=0,this.maxColHeight=0,this.colWidth=0,this.error=!1,this.cols=[],treesaver.dom.getElementsByClassName("column",e).forEach(function(e){var t=new treesaver.layout.Column(e,this.size.h);this.cols.push(t),this.textHeight+=t.h,this.maxColHeight=Math.max(this.maxColHeight,t.h),this.colWidth?this.colWidth!==e.offsetWidth&&(treesaver.debug.error("Inconsistent column widths in grid"),this.error=!0):this.colWidth=e.offsetWidth},this),this.containers=[],treesaver.dom.getElementsByClassName("container",e).forEach(function(e){var t=new treesaver.layout.Container(e,this.size.h);this.containers.push(t)},this),this.html=treesaver.dom.outerHTML(e),document.body.removeChild(e)},treesaver.layout.Grid.knownFlags={onlypage:!0,odd:!0,even:!0,sizetocontainer:!0},treesaver.layout.Grid.pageFlagRegex=/^(no-)?page-(\d+)$/,treesaver.layout.Grid.prototype.findScoringFlags=function(){var e=!1,t,n;this.scoringFlags={},this.pageNumberFlags={},this.pageNumberNegationFlags={},this.classes.forEach(function(r){if(r in treesaver.layout.Grid.knownFlags)this.scoringFlags[r]=!0;else if(t=treesaver.layout.Grid.pageFlagRegex.exec(r))n=parseInt(t[2],10),isNaN(n)||(r.substr(0,3)==="no-"?this.pageNumberNegationFlags[n]=!0:(e=!0,this.pageNumberFlags[n]=!0))},this),e||(this.pageNumberFlags=null)},treesaver.layout.Grid.prototype.stretch=function(e){if(!this.flexible)return this;var t,n,r,i=e-(this.size.marginHeight+this.size.bpHeight),s=Math.min(this.size.maxH,Math.max(i,this.size.minH)),o=s-this.size.minH||0;return s-=o%this.lineHeight,this.maxColHeight=0,this.textHeight=0,this.cols.forEach(function(e){this.textHeight+=e.stretch(s).h,this.maxColHeight=Math.max(this.maxColHeight,e.h)},this),this.containers.forEach(function(e){e.stretch(s)},this),this.stretchedSize=this.size.clone(),this.stretchedSize.h=s,this.stretchedSize.outerH=s+this.size.bpHeight,this.scoringFlags.sizetocontainer?this.stretchedSize.maxH=this.size.maxH:this.stretchedSize.maxH=Math.min(this.size.maxH,s+this.lineHeight*3),this},treesaver.layout.Grid.sort=function(e,t){return t.size.w+20*t.containers.length-(e.size.w+20*e.containers.length)},treesaver.layout.Grid.prototype.score=function(e,t){var n=0,r=t.pageNumber+1;return n+=this.cols.length*treesaver.layout.Grid.SCORING.COLUMN,this.lineHeight!==e.lineHeight&&(n-=treesaver.layout.Grid.SCORING.DIFFERENT_LINEHEIGHT),this.colWidth&&this.colWidth!==e.colWidth&&(n-=treesaver.layout.Grid.SCORING.DIFFERENT_COLWIDTH),this.scoringFlags.onlypage&&(n+=t.pageNumber?-treesaver.layout.Grid.SCORING.NON_ONLY_PAGE:treesaver.layout.Grid.SCORING.ONLY_PAGE),this.pageNumberFlags&&(this.pageNumberFlags[r]?n+=treesaver.layout.Grid.SCORING.PAGE_NUMBER:n-=treesaver.layout.Grid.SCORING.NON_PAGE_NUMBER),this.pageNumberNegationFlags[r]&&(n-=treesaver.layout.Grid.SCORING.NON_PAGE_NUMBER),r%2?n+=this.scoringFlags.odd?treesaver.layout.Grid.SCORING.ODD_PAGE:this.scoringFlags.even?-treesaver.layout.Grid.SCORING.NON_EVEN_ODD:0:n+=this.scoringFlags.even?treesaver.layout.Grid.SCORING.EVEN_PAGE:this.scoringFlags.odd?-treesaver.layout.Grid.SCORING.NON_EVEN_ODD:0,n},treesaver.layout.Grid.ContainerMap,treesaver.layout.Grid.prototype.mapContainers=function(e,t){var n,r,i,s,o,u,a,f,l,c,h,p,d=[];for(n=0,r=this.containers.length;n<r;n+=1){i=this.containers[n],d[n]=null,u=t.figureIndex,h=t.delayed.slice(0);e:while(h.length||u<e.figures.length){(p=!!h.length)?a=h.shift():a=u,f=e.figures[a];t:for(s=i.sizes.length-1;s>=0;s-=1){o=i.sizes[s],l=f.getSize(o);if(l){if(i.flexible&&l.minH&&l.minH>i.h)continue t;d[n]={figureIndex:a,figureSize:l,size:o,flexible:i.flexible},t.useFigure(a);break e}}if(!f.optional)break;p||(u+=1)}}return d},treesaver.layout.Grid.prototype.hasTheme=function(e){return this.classes.indexOf(e)!==-1},treesaver.layout.Grid.prototype.capabilityFilter=function(){return this.requirements?treesaver.capabilities.check(this.requirements,!0):!0},treesaver.layout.Grid.prototype.sizeFilter=function(e){var t={w:e.w-this.size.bpWidth,h:e.h-this.size.bpHeight-this.size.marginHeight};return treesaver.dimensions.inSizeRange(this.size,t)},treesaver.layout.Grid.SCORING={FINISH_TEXT:250,FINISH_ALL:2e3,FIXED_CONTAINER:5e3,COLUMN:50,EMPTINESS_PENALTY:2e3,EMPTY_CONTAINER_PENALTY:5e3,DIFFERENT_LINEHEIGHT:2e3,DIFFERENT_COLWIDTH:Infinity,CONTAINER_BONUS:2e3,CONTAINER_AREA_BONUS:5,BLOCK_DELAY_PENALTY:100,REQUIRED_BLOCK_BONUS:4e3,PAGE_NUMBER:3e3,ONLY_PAGE:4e3,ODD_PAGE:2e3,EVEN_PAGE:2e3,NON_EVEN_ODD:Infinity,NON_ONLY_PAGE:Infinity,NON_PAGE_NUMBER:Infinity},treesaver.layout.Grid.best=function(e,t,n){goog.DEBUG&&(e?t.length?n||treesaver.debug.error("No breakRecord passed to grid.best"):treesaver.debug.error("No grids passed to grid.best"):treesaver.debug.error("No content passed to grid.best"));var r=null,i=-Infinity,s,o,u=e.blocks.length,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x;
for(c=0,h=t.length;c<h;c+=1){p=t[c],S=0,x=!1,d=n.clone(),m=d.overhang,g=p.textHeight-m,m&&p.textHeight&&(x=!0),v=p.score(e,d),o=p.mapContainers(e,d);for(y=0,b=o.length;y<b;y+=1)w=p.containers[y],E=o[y],E?(l=e.figures[E.figureIndex],v+=treesaver.layout.Grid.SCORING.CONTAINER_BONUS+E.figureSize.minH*treesaver.layout.Grid.SCORING.CONTAINER_AREA_BONUS,l.optional||(v+=treesaver.layout.Grid.SCORING.REQUIRED_BLOCK_BONUS),w.flexible||(v+=treesaver.layout.Grid.SCORING.FIXED_CONTAINER),S+=1):w.flexible||(v-=treesaver.layout.Grid.SCORING.EMPTY_CONTAINER_PENALTY);e:while(p.textHeight&&d.index<u&&m<=p.textHeight){a=e.blocks[d.index],f=a.metrics.outerH+a.metrics.marginTop;if(a.keeptogether&&(f>p.maxColHeight||f>g))break e;if(f>g){if(a.keeptogether)break e;if(a.children){d.index+=1;continue e}m+=f}m+=f,v+=f,g-=f,x=!0,d.index=a.nextSibling?a.nextSibling.index:d.index+1}x?g>0&&(s=g/p.textHeight,s-=S*.2,s>.5&&(treesaver.debug.info("Grid penalized for emptiness percentage: "+s*100),v-=g,v-=s*s*treesaver.layout.Grid.SCORING.EMPTINESS_PENALTY)):S?(a=e.blocks[d.index],a&&a.figure&&!a.figure.optional&&(d.overhang||a.withinFallback)&&(treesaver.debug.warn("No forward progress on required figure fallback"),v=-Infinity)):v=-Infinity,v>i&&(i=v,r={grid:p,containers:o})}return r},goog.DEBUG&&(treesaver.layout.Grid.prototype.toString=function(){return"[Grid "+this.classes+"]"}),goog.provide("treesaver.layout.Page"),goog.require("treesaver.array"),goog.require("treesaver.dimensions"),goog.require("treesaver.dom"),goog.require("treesaver.layout.BreakRecord"),goog.require("treesaver.layout.Grid"),goog.require("treesaver.layout.Block"),treesaver.layout.Page=function(e,t,n){var r=treesaver.layout.Grid.best(e,t,n),i=document.createElement("div"),s=n.clone(),o=!1;this.ignore;if(!r||!r.grid){n.finished=n.atEnd(e)||n.figureIndex===e.figures.length,n.finished?(treesaver.debug.info("Finished article in face of error."),this.ignore=!0):(treesaver.debug.error("No best grid found: "+arguments),this.error=!0);return}this.size=r.grid.stretchedSize.clone(),this.begin=n.getPosition(),treesaver.dom.addClass(i,"offscreen"),document.body.appendChild(i),i.innerHTML=r.grid.html,this.node=i.firstChild,treesaver.dimensions.setCssPx(this.node,"width",this.size.w),treesaver.dimensions.setCssPx(this.node,"height",this.size.h),treesaver.object.keys(e.fields||{}).forEach(function(t){var n=treesaver.template.getElementsByBindName(t,null,this.node);n.forEach(function(n){var r={};r[t]=e.fields[t],treesaver.layout.Page.fillField(n,r)})},this),treesaver.dom.getElementsByClassName("container",this.node).forEach(function(t,i){var s=r.containers[i],u,a,f;s?(a=s.figureIndex,u=e.figures[a],f=treesaver.layout.Page.fillContainer(t,u,s,e.lineHeight),f?(n.useFigure(a),o=!0,u.zoomable&&(treesaver.dom.addClass(t,"zoomable"),t.setAttribute("data-figureindex",a),(WITHIN_IOS_WRAPPER||treesaver.capabilities.SUPPORTS_TOUCH)&&t.setAttribute("onclick","void(0)")),i===0&&r.grid.scoringFlags.sizetocontainer&&(this.size.h=treesaver.dimensions.getOffsetHeight(t)+r.grid.containers[0].delta,this.size.outerH=this.size.h+this.size.bpHeight,treesaver.dimensions.setCssPx(this.node,"height",this.size.h))):(treesaver.debug.info("Container failure, figureIndex: "+a),!u.optional&&u.fallback?n.delayFigure(u.figureIndex):treesaver.dom.hasClass(t,"flexed")||n.failedFigure(a),t.parentNode.removeChild(t))):t.parentNode.removeChild(t)},this),treesaver.dom.getElementsByClassName("column",this.node).forEach(function(t,i){var s=r.grid.cols[i];treesaver.layout.Page.fillColumn(e,n,t,r.grid.maxColHeight,s.minH)}),s.equals(n)?(treesaver.debug.error("No progress made in pagination: "+arguments+r),this.error=!0):!o&&r.grid.scoringFlags.sizetocontainer?(treesaver.debug.warn("sizetocontainer not filled, page ignored"),this.ignore=!0):(treesaver.dimensions.setCssPx(this.node,"marginTop",-this.size.outerH/2),this.html=i.innerHTML,this.end=n.getPosition(),this.active=!1,n.pageNumber+=1,n.finished=r.grid.scoringFlags.onlypage||n.atEnd(e)),i.removeChild(this.node),this.node=null,document.body.removeChild(i),i=null},treesaver.layout.Page.fillContainer=function(e,t,n,r){var i,s,o,u,a,f=!0;i=n.size,s=n.figureSize,goog.DEBUG&&(i||treesaver.debug.error("Empty size!"),s||treesaver.debug.error("Empty figureSize!")),a=treesaver.dimensions.getOffsetHeight(e),s.applySize(e,i);if(!n.flexible)return!0;treesaver.dom.hasClass(e,"bottom")?(f=!1,e.style.top="auto"):e.style.bottom="auto",o=treesaver.dimensions.getOffsetHeight(e);if(o>a)return treesaver.debug.info("Container failure: "+o+":"+a),goog.DEBUG&&(e.setAttribute("data-containerHeight",o),e.setAttribute("data-maxHeight",a),e.setAttribute("data-attemptedSize",i)),s.revertSize(e,i),!1;r&&o%r&&(o=treesaver.dimensions.roundUp(o,r)),u=e;while(u=u.nextSibling){if(u.nodeType!==1)continue;u=u;if(treesaver.dom.hasClass(u,"fixed"))continue;if(treesaver.dom.hasClass(u,"column")||treesaver.dom.hasClass(u,"container")||treesaver.dom.hasClass(u,"group"))treesaver.dom.addClass(u,"flexed"),treesaver.dimensions.getOffsetHeight(u)<=o?(treesaver.debug.info("Sibling shrunk to zero height: "+u),treesaver.dimensions.setCssPx(u,"height",0)):f?treesaver.dimensions.setCssPx(u,"top",treesaver.dimensions.getOffsetTop(u)+o):treesaver.dimensions.setCssPx(u,"bottom",treesaver.dimensions.getOffsetHeight(u.offsetParent)-(treesaver.dimensions.getOffsetTop(u)+treesaver.dimensions.getOffsetHeight(u))+o)}return!0},treesaver.layout.Page.fillColumn=function(e,t,n,r,i){var s=treesaver.dimensions.getOffsetHeight(n),o=0,u,a,f=!0,l=0,c=0,h=0,p=0,d=[],v=e.blocks.length,m=e.blocks[t.index],g,y,b,w=[],E,S=!1,x=r/s>1.5;if(!m)return;s%e.lineHeight&&(s-=s%e.lineHeight);if(!s||s<i){treesaver.debug.info("Column below minHeight: "+m+":"+s);return}m.parent&&d.push(m.openAllTags(!0)),l=t.overhang?m.metrics.outerH-t.overhang:0;e:while(t.index<v&&o<s){m=e.blocks[t.index],g=m.nextSibling,y=g||m.getNextNonChildBlock();if(m.isFallback&&t.figureUsed(m.figure.figureIndex)&&(!f||!t.overhang)){m.parent&&!m.nextSibling&&treesaver.debug.error("Must close out parent tags on unused fallback!"),t.index=y?y.index:v;continue e}b=m.parent,u=s-o,f&&!h?(h=-l,c=t.overflow?m.metrics.lineHeight:m.firstLine):(h=Math.max(h,m.metrics.marginTop),c=h+m.firstLine),p=Math.max(m.metrics.marginBottom,g?g.metrics.marginTop:0),E=m.metrics.outerH+h,S=u<c,!S&&m.keepwithnext&&g&&!(t.overhang||f&&!x)&&(S=u>=E&&u<E+p+g.firstLine,S&&treesaver.debug.info("Leaving column due to keepwithnext")),S&&(S=!f||x,S?x?treesaver.debug.info("Leaving column empty due to being short"):f||treesaver.debug.info("Ending column early due to non-fit"):treesaver.debug.info("Staying in virgin column despite non-fit")),S&&(S=!m.containsFallback),m.columnBreak&&!f&&(S=!0);if(S){if(b){while(b&&b.index===m.index-1)treesaver.debug.info("Backing out opened tag: "+b.openTag),d.pop(),t.index=b.index,b.isFallback&&t.delayFigure(b.figure.figureIndex),m=b,b=m.parent;b&&d.push(m.closeAllTags())}break e}m.isFallback&&t.useFigure(m.figure.figureIndex);if(m.containsFallback||m.blocks.length&&u<E){t.overhang&&treesaver.debug.error("Overhang present when opening a parent block"),m.metrics.bpTop&&(o+=f?0:h,h=0,o+=m.metrics.bpTop),d.push(m.openTag),t.index+=1;continue e}o+=E,d.push(m.html),f=!1,a=a||m,t.overhang=0;if(s>o+p){t.index=y?y.index:v;if(!g&&b){w=[];do w.push(b.closeTag),b.metrics.bpBottom?(o+=p+b.metrics.bpBottom,p=b.metrics.marginBottom):p=Math.max(p,b.metrics.marginBottom);while(!b.nextSibling&&(b=b.parent));if(!(s>o+p)){b&&d.push(m.closeAllTags()),o=s;break e}d.push(w.join(""))}h=p;continue e}b&&d.push(m.closeAllTags()),m.breakable?(o<=s&&(t.index=y?y.index:v,o=s),m.keeptogether&&treesaver.debug.warn("keeptogether element shoved into column")):(o=s,t.index=y?y.index:v,treesaver.debug.warn("Unbreakable element shoved into column"));break e}s=treesaver.layout.Page.computeOverhang(t,m,s,o),goog.DEBUG&&(n.setAttribute("data-overhang",t.overhang),n.setAttribute("data-contentHeight",o),a&&n.setAttribute("data-firstBlock",a.index),m&&n.setAttribute("data-lastBlock",m.index)),treesaver.dimensions.setCssPx(n,"height",s),n.innerHTML=d.join("");if(a&&n.firstChild){n.firstChild.style.marginTop=-l+"px";if(a.parent&&!l){b=a.parent;while(b)b.metrics.bpTop&&(a=b),b=b.parent;if(b!==a){b=a.parent,m=n.firstChild;while(b)m=m.firstChild,b=b.parent,m?m.style.marginTop=0:treesaver.debug.error("No block on fucked up code")}}else if(a.blocks.length&&!l){m=n.firstChild;while(a)a.blocks.length&&m.firstChild?(a=a.blocks[0],m=m.firstChild,m.style.marginTop=0):a=null}}else treesaver.debug.warn("Clearing column contents since no block was added"),treesaver.dom.clearChildren(n)},treesaver.layout.Page.computeOverhang=function(e,t,n,r){var i,s;return n>=r||!t?(e.overhang=0,n):(t.breakable||treesaver.debug.error("Overhang on unbreakable element"),t.blocks.length&&treesaver.debug.error("Overhang on element with children"),e.overhang=r-n,i=e.overhang-t.metrics.bpBottom,i<=0?(e.overhang=0,e.index=t.index+1):(s=(t.metrics.h-i)%t.metrics.lineHeight,s&&(n-=s,e.overhang+=s)),n)},treesaver.layout.Page.fillField=function(e,t){treesaver.template.expand(t,e)},treesaver.layout.Page.prototype.activate=function(){return this.active?this.node:(this.node=treesaver.dom.createElementFromHTML(this.html),this.active=!0,this.node)},treesaver.layout.Page.prototype.deactivate=function(){this.active=!1,this.node=null},treesaver.layout.Page.prototype.clone=function(){var e=treesaver.object.clone(this);return e.node=this.node&&this.node.cloneNode(!0)||null,e.active=this.active,e},goog.DEBUG&&(treesaver.layout.Page.prototype.toString=function(){return"[Page]"}),goog.provide("treesaver.network"),goog.require("treesaver.array"),goog.require("treesaver.capabilities"),goog.require("treesaver.constants"),goog.require("treesaver.debug"),goog.require("treesaver.scheduler"),treesaver.network.DEFAULT_TIMEOUT=1e4,treesaver.network.events={ONLINE:"treesaver.online",OFFLINE:"treesaver.offline"},treesaver.network.watchedEvents_=["offline","online"],treesaver.network.watchedCacheEvents_=["uncached","idle","checking","downloading","updateready","obsolete"],treesaver.network.isLoaded_=!1,treesaver.network.load=function(){treesaver.network.isLoaded_||(treesaver.network.isLoaded_=!0,treesaver.network.watchedEvents_.forEach(function(e){treesaver.events.addListener(document,e,treesaver.network)}),treesaver.capabilities.SUPPORTS_APPLICATIONCACHE&&treesaver.network.loadedFromCache_&&treesaver.network.watchedCacheEvents_.forEach(function(e){treesaver.events.addListener(window.applicationCache,e,treesaver.network)}))},treesaver.network.unload=function(){treesaver.network.isLoaded_&&(treesaver.network.isLoaded_=!1,treesaver.network.watchedEvents_.forEach(function(e){treesaver.events.removeListener(window,e,treesaver.network)}),treesaver.capabilities.SUPPORTS_APPLICATIONCACHE&&treesaver.network.loadedFromCache_&&treesaver.network.watchedCacheEvents_.forEach(function(e){treesaver.events.removeListener(window.applicationCache,e,treesaver.network)}))},treesaver.network.isOnline=function(){return"onLine"in window.navigator?window.navigator.onLine:!0},treesaver.network.loadedFromCache_=treesaver.capabilities.SUPPORTS_APPLICATIONCACHE&&!!window.applicationCache.status,treesaver.network.loadedFromCache=function(){return treesaver.network.loadedFromCache_},treesaver.network.handleEvent=function(e){treesaver.debug.info("Network event recieved: "+e);switch(e.type){case"online":treesaver.debug.info("Application online"),treesaver.capabilities.updateClasses(),treesaver.events.fireEvent(window,treesaver.network.events.ONLINE);return;case"offline":treesaver.debug.info("Application offline"),treesaver.capabilities.updateClasses(),treesaver.events.fireEvent(window,treesaver.network.events.OFFLINE);return;case"updateready":treesaver.debug.info("Updating application cache"),window.applicationCache.swapCache();return;case"error":treesaver.debug.warn("Application Cache Error: "+e);return}},treesaver.network.urlToPath=function(e){var t,n,r;return SUPPORT_IE&&treesaver.capabilities.IS_LEGACY?(n=document.createElement("div"),n.style.display="none",document.body.appendChild(n),n.innerHTML='<a href="'+e+'"></a>',t=n.firstChild):(t=document.createElement("a"),t.href=e),r=t.pathname,SUPPORT_IE&&treesaver.capabilities.IS_LEGACY&&(document.body.removeChild(n),n.removeChild(t)),r.charAt(0)!=="/"&&(r="/"+r),r},treesaver.network.stripHash=function(e){var t=e.indexOf("#");return t===-1?e:e.substr(0,t)},treesaver.network.protocolRegex_=/^https?:\/\//i,treesaver.network.absoluteURL=function(e){if(e&&e.charAt(0)==="/"||treesaver.network.protocolRegex_.test(e))return e;var t=document.createElement("a"),n,r;return SUPPORT_IE&&treesaver.capabilities.IS_LEGACY&&(n=document.createElement("div"),document.body.appendChild(n),n.appendChild(t)),t.href=e,r=t.href,SUPPORT_IE&&treesaver.capabilities.IS_LEGACY&&(document.body.removeChild(n),n.removeChild(t)),r},treesaver.network.get=function(t,n,r){treesaver.debug.info("XHR request to: "+t);var i={xhr:new XMLHttpRequest,url:t,callback:n};treesaver.scheduler.delay(function(){treesaver.network.requestTimeout_(i)},r||treesaver.network.DEFAULT_TIMEOUT,[],treesaver.network.makeRequestId_(i)),i.xhr.onreadystatechange=treesaver.network.createHandler_(i);try{i.xhr.open("GET",i.url,!0),i.xhr.send(null)}catch(s){treesaver.debug.warn("XHR Request exception: "+s),treesaver.network.requestError_(i)}},treesaver.network.makeRequestId_=function(e){return"fetch:"+e.url},treesaver.network.createHandler_=function(t){return function(){t.xhr.readyState===4&&(t.xhr.status===0||t.xhr.status===200||t.xhr.status===304?(treesaver.debug.info("XHR response from: "+t.url),t.callback(t.xhr.responseText,t.url),treesaver.network.cleanupRequest_(t)):(treesaver.debug.warn("XHR request failed for: "+t.url),treesaver.network.requestError_(t)))}},treesaver.network.cleanupRequest_=function(t){treesaver.scheduler.clear(treesaver.network.makeRequestId_(t)),t.xhr.onreadystatechange=null},treesaver.network.requestError_=function(t){t.callback(null,t.url),treesaver.network.cleanupRequest_(t)},treesaver.network.requestTimeout_=function(t){t.xhr.abort(),treesaver.network.requestError_(t)},goog.provide("treesaver.ui.Article"),goog.require("treesaver.array"),goog.require("treesaver.debug"),goog.require("treesaver.constants"),goog.require("treesaver.dimensions"),goog.require("treesaver.dom"),goog.require("treesaver.events"),goog.require("treesaver.layout.BreakRecord"),goog.require("treesaver.layout.Content"),goog.require("treesaver.layout.ContentPosition"),goog.require("treesaver.layout.Grid"),goog.require("treesaver.layout.Page"),goog.require("treesaver.network"),goog.require("treesaver.scheduler"),treesaver.ui.Article=function(e,t,n,r){this.theme=null,this.content=null,this.url=e,this.path=treesaver.network.urlToPath(e),this.title=t,this.br=null,this.pageCount=0,this.pages=[],this.paginationClean=!1,this.paginationComplete=!1,this.loaded=!1,this.loading=!1,this.loadFailed=!1,this.error=!1,this.maxPageSize=null,this.constraint=null,this.eligible_grids=[],this.grids=n,r&&this.processHTML(r)},treesaver.ui.Article.events={LOADFAILED:"treesaver.loadfailed",LOADED:"treesaver.loaded",PAGINATIONERROR:"treesaver.paginationerror",PAGINATIONPROGRESS:"treesaver.paginationprogress"},treesaver.ui.Article.titleRegExp=/<title>\s*(.+?)\s*<\/title>/i,treesaver.ui.Article.extractTitle=function(e){var t=treesaver.ui.Article.titleRegExp.exec(e);return t&&t[1]?t[1]:null},treesaver.ui.Article.prototype.processHTML=function(e){this.loaded=!0;var t=document.createElement("div"),n=document.createElement("div"),r,i=treesaver.ui.Article.extractTitle(e);i&&(this.title=i),t.style.display="none",treesaver.dom.addClass(t,"offscreen grid"),treesaver.dom.addClass(n,"column"),document.body.appendChild(t),t.innerHTML=e,r=document.getElementById("ts_content")||treesaver.dom.getElementsByTagName("article",t)[0];if(!r)return treesaver.debug.error("Could not find article content in HTML: "+e),document.body.removeChild(t),this.error=!0,!1;r.removeAttribute("id"),treesaver.dom.clearChildren(t),this.theme=r.getAttribute("data-theme")||r.getAttribute("data-grids")||null,this.theme&&(treesaver.dom.addClass(t,this.theme),treesaver.dom.addClass(n,this.theme),this.setGrids(this.grids));while(r.firstChild)n.appendChild(r.firstChild);return t.appendChild(n),n.style.display="block",t.style.display="block",this.content=new treesaver.layout.Content(n),document.body.removeChild(t),t.removeChild(n),treesaver.dom.clearChildren(n),this.resetPagination(),!0},treesaver.ui.Article.prototype.setGrids=function(e){this.theme?this.grids=e.filter(function(e){return e.hasTheme(this.theme)},this):this.grids=e.slice(0)},treesaver.ui.Article.prototype.stretchGrids=function(e){this.eligible_grids=this.grids.filter(function(t){return t.capabilityFilter()&&t.sizeFilter(e)}).map(function(t){return t.stretch(e.h)}),this.eligible_grids.length||treesaver.debug.error("No eligible grids at "+e.w+"x"+e.h),this.eligible_grids.sort(treesaver.layout.Grid.sort)},treesaver.ui.Article.prototype.setMaxPageSize=function(e){if(!this.maxPageSize||this.maxPageSize.w!==e.w||this.maxPageSize.h!==e.h)this.maxPageSize=e,this.paginationClean=treesaver.dimensions.inSizeRange(this.constraint,e);return!this.paginationClean},treesaver.ui.Article.prototype.resetPagination=function(){treesaver.scheduler.clear("paginate"),this.pages=[],this.pageCount=0,this.maxPageSize&&this.stretchGrids(this.maxPageSize),this.br=new treesaver.layout.BreakRecord,this.constraint=null,this.paginationClean=!0,this.paginationComplete=!1},treesaver.ui.Article.prototype.paginate=function(e,t,n){if(goog.DEBUG){if(!this.content){treesaver.debug.error("Tried to paginate missing content");return}if(!this.maxPageSize){treesaver.debug.error("Tried to paginate without a page size");return}if(this.paginationComplete){treesaver.debug.info("Needless call to paginate");return}}treesaver.scheduler.clear("paginate");var r;t=t||0;while(!this.br.finished){r=new treesaver.layout.Page(this.content,this.eligible_grids,this.br);if(r.ignore){this.br.finished?treesaver.debug.info("Page ignored during pagination and article terminated"):treesaver.debug.info("Page ignored during pagination");if(this.br.finished)break;continue}if(r.error){if(this.br.finished)break;this.error=!0,treesaver.events.fireEvent(document,treesaver.ui.Article.events.PAGINATIONERROR,{article:this}),this.br.finished=!0;break}this.pages.push(r),this.pageCount+=1,this.error=!1,this.constraint=treesaver.dimensions.mergeSizeRange(this.constraint,r.size,!0);if(t&&this.pageCount<=t||n&&(n===treesaver.layout.ContentPosition.END||!n.lessOrEqual(r.end)))continue;if(!this.br.finished){e&&(treesaver.events.fireEvent(document,treesaver.ui.Article.events.PAGINATIONPROGRESS,{article:this}),this.paginateAsync(treesaver.array.toArray(arguments)));return}}this.paginationComplete=!0,treesaver.events.fireEvent(document,treesaver.ui.Article.events.PAGINATIONPROGRESS,{article:this,completed:!0})},treesaver.ui.Article.prototype.paginateAsync=function(e){treesaver.scheduler.delay(treesaver.ui.Article.prototype.paginate,PAGINATE_DEBOUNCE_TIME,e,"paginate",this)},treesaver.ui.Article.prototype.getPageWidth=function(){return this.constraint?this.constraint.w:0},treesaver.ui.Article.prototype.getPages=function(e,t){if(goog.DEBUG&&!this.loaded)return this.loading||treesaver.debug.error("Tried to getPages on non-loaded article"),new Array(t);this.paginationClean||this.resetPagination();var n=[],r=e>=0?e+t-1:Infinity,i,s;!this.paginationComplete&&r>this.pages.length-1&&this.paginateAsync([!0,r]);if(!this.paginationComplete){n.length=t;if(e<0)return n}else t=Math.min(t,this.pageCount-(e>=0?e:e-1));if(e<0)for(i=-e;i<=t;i+=1)n[i+e]=this.pages[this.pageCount-i];else for(i=e;i<e+t;i+=1)n[i-e]=this.pages[i];return n},treesaver.ui.Article.prototype.getPageIndex=function(e){if(!this.content)return-1;var t,n,r;if(!e||e.atBeginning())return 0;this.paginationClean||this.resetPagination();if(!this.paginationComplete)if(e===treesaver.layout.ContentPosition.END||!this.pageCount||!e.lessOrEqual(this.pages[this.pageCount-1].end))return this.paginateAsync([!0,null,e]),-1;if(e===treesaver.layout.ContentPosition.END)return this.paginationComplete?this.pageCount-1:-1;for(t=0,n=this.pageCount;t<n;t+=1)if(this.pages[t].end.greater(e))return t;return this.paginationComplete?this.pageCount-1:-1},goog.DEBUG&&(treesaver.ui.Article.prototype.toString=function(){return"[treesaver.ui.Article]"}),goog.provide("treesaver.microdata"),goog.require("treesaver.array"),goog.require("treesaver.constants"),goog.require("treesaver.dom"),goog.require("treesaver.string");if(SUPPORT_MICRODATA&&!treesaver.capabilities.SUPPORTS_MICRODATA){function getItemValue(e){var t=e.nodeName;return t==="META"?e.content:["AUDIO","EMBED","IFRAME","IMG","SOURCE","VIDEO"].indexOf(t)!==-1?e.src:["A","AREA","LINK"].indexOf(t)!==-1?e.href:t==="OBJECT"?e.data:t==="TIME"&&treesaver.dom.hasAttr(e,"datetime")?e.dateTime:treesaver.dom.innerText(e)}function getProperties(e){var t=e,n=[],r=[],i=[],s=[],o;s=treesaver.array.toArray(t.childNodes),n=s.filter(function(e){return e.nodeType===1}),treesaver.dom.hasAttr(t,"itemref")&&(i=t.getAttribute("itemref").trim().split(/\s+/),i.forEach(function(e){var t=document.getElementById(e);t&&n.push(t)})),n=n.filter(function(e,t){var r=null,i=e,s=[];if(n.indexOf(e)!==t&&n.indexOf(e,t)!==-1)return!1;while((i=i.parentNode)!==null&&i.nodeType===1){s.push(i);if(treesaver.dom.hasAttr(i,"itemscope")){r=i;break}}return r!==null?n.indexOf(r)!==-1?!1:!s.some(function(e){var t=-1,i,s=null;if((t=n.indexOf(e))!==-1){i=n[t];while((i=i.parentNode)!==null&&i.nodeType===1)if(treesaver.dom.hasAttr(i,"itemscope")){s=i;break}if(s===r)return!0}return!1}):!0}),n.sort(function(e,t){return 3-(treesaver.dom.compareDocumentPosition(t,e)&6)});while(o=n.pop())treesaver.dom.hasAttr(o,"itemprop")&&(r.push(o),treesaver.dom.hasAttr(o,"itemscope")&&(o.itemScope=!0,o.properties=getProperties(o))),treesaver.dom.hasAttr(o,"itemscope")||(s=treesaver.array.toArray(o.childNodes).reverse(),s.forEach(function(e){e.nodeType===1&&n.push(e)}));return r.forEach(function(e){treesaver.dom.hasAttr(e,"itemscope")?e.itemValue=e:e.itemValue=getItemValue(e),e.itemProp=e.getAttribute("itemprop")}),r}function getItems(e,t){var n=[];return e&&/\S/.test(e)?e=e.trim().split(/\s+/):e=[],t&&treesaver.dom.hasAttr(t,"itemscope")&&n.push(t),n=n.concat(treesaver.dom.getElementsByProperty("itemscope",null,null,t)),n=n.filter(function(t){if(!treesaver.dom.hasAttr(t,"itemprop"))if(e.length===0||treesaver.dom.hasAttr(t,"itemtype")&&e.indexOf(t.getAttribute("itemtype"))!==-1)return t.itemScope=!0,t.properties=getProperties(t),treesaver.dom.hasAttr(t,"itemid")&&(t.itemId=t.getAttribute("itemid")),treesaver.dom.hasAttr(t,"itemref")&&(t.itemRef=t.getAttribute("itemRef")),treesaver.dom.hasAttr(t,"itemtype")&&(t.itemType=t.getAttribute("itemtype")),!0;return!1}),n}document.getItems=getItems}SUPPORT_MICRODATA&&(treesaver.microdata.getObject_=function(e){var t={},n={},r={};return e.itemType&&(t.type=e.itemType),e.itemId&&(t.id=e.itemId),treesaver.dom.hasAttr(e,"data-properties")&&(e.getAttribute("data-properties").split(/\s+/g).forEach(function(e){r[e]=!0}),t.flags=r),e.properties.forEach(function(e){var t=e.itemValue,r=[];t.itemScope&&(t=treesaver.microdata.getObject_(t)),r=e.itemProp.split(/\s+/g),r.forEach(function(e){n[e]||(n[e]=[]),n[e].push(t)})}),t.properties=n,t},treesaver.microdata.getItems=function(e,t){if(treesaver.capabilities.SUPPORTS_MICRODATA){var n=treesaver.array.toArray(document.getItems(e));return t?n.filter(function(e){return t.contains(e)}):n}return document.getItems(e,t)},treesaver.microdata.getJSONItems=function(e,t){var n=treesaver.microdata.getItems(e,t);return n.map(function(e){return treesaver.microdata.getObject_(e)})},treesaver.microdata.normalizeItem=function(e){var t={},n;return e.properties&&(n=treesaver.object.keys(e.properties),n.forEach(function(n){var r=e.properties[n][0];treesaver.object.isObject(r)&&(r=treesaver.layout.normalizeItem(r)),t[n]=r})),t}),goog.provide("treesaver.resources"),goog.require("treesaver.constants"),goog.require("treesaver.debug"),goog.require("treesaver.dom"),goog.require("treesaver.network"),treesaver.resources.load=function(e){var t=treesaver.resources.getResourcesLinkUrl_();if(!t){treesaver.debug.error("No link to resources found"),e();return}if(treesaver.resources.loadStatus_){treesaver.resources.loadStatus_===treesaver.resources.LoadStatus.LOADED?e():treesaver.resources.callbacks_.push(e);return}treesaver.debug.info("Loading resources from: "+t),treesaver.resources.loadStatus_=treesaver.resources.LoadStatus.LOADING,treesaver.resources.callbacks_=[e],treesaver.network.get(t,treesaver.resources.processResourceFile)},treesaver.resources.processResourceFile=function(e){treesaver.resources.container_=document.createElement("div");if(e){var t=document.createElement("div");t.style.display="none",SUPPORT_IE&&treesaver.dom.safeAppendToDocument(t),t.innerHTML=e,treesaver.array.toArray(t.childNodes).forEach(function(e){e.nodeType===1&&e.nodeName.toLowerCase()==="div"?treesaver.resources.container_.appendChild(e):e.nodeType===1&&e.nodeName.toLowerCase()==="body"&&treesaver.array.toArray(e.childNodes).forEach(function(e){e.nodeType===1&&e.nodeName.toLowerCase()==="div"&&treesaver.resources.container_.appendChild(e)})}),SUPPORT_IE&&t.parentNode.removeChild(t),t.innerHTML=""}else treesaver.debug.error("Could not load resource file");treesaver.resources.loadComplete_()},treesaver.resources.loadComplete_=function(){treesaver.resources.loadStatus_=treesaver.resources.LoadStatus.LOADED;var e=treesaver.resources.callbacks_.slice(0);treesaver.resources.callbacks_=[],e.forEach(function(e){e()})},treesaver.resources.findByClassName=function(e){return treesaver.resources.container_?treesaver.dom.getElementsByClassName(e,treesaver.resources.container_):[]},treesaver.resources.unload=function(){treesaver.resources.container_=null,treesaver.resources.loadStatus_=treesaver.resources.LoadStatus.NOT_LOADED,treesaver.resources.callbacks_=[]},treesaver.resources.getResourcesLinkUrl_=function(){var e=document.getElementsByTagName("link"),t,n=e.length;for(t=0;t<n;t+=1)if(e[t].rel.toLowerCase().indexOf("resources")!==-1)return e[t].getAttribute("href");return null},treesaver.resources.LoadStatus={LOADED:2,LOADING:1,NOT_LOADED:0},treesaver.resources.loadStatus_,treesaver.resources.callbacks_,treesaver.resources.container_,goog.provide("treesaver.json"),goog.require("treesaver.capabilities"),goog.require("treesaver.constants"),goog.require("treesaver.debug"),treesaver.json.parse=function(e){return window.JSON.parse(e)},treesaver.json.stringify=function(e){return window.JSON.stringify(e)},SUPPORT_LEGACY&&!("JSON"in window)&&(treesaver.debug.info("Non-native JSON implementation"),treesaver.json.parse=function(str){var s="("+str+")";try{return eval(s)}catch(ex){}return null},treesaver.json.stringify=function(e){return""}),goog.provide("treesaver.storage"),goog.require("treesaver.array"),goog.require("treesaver.debug"),goog.require("treesaver.json"),treesaver.storage.set=function(t,n,r){var i=r?window.localStorage:window.sessionStorage;(!SUPPORT_IE||i.getItem(t))&&i.removeItem(t);try{i.setItem(t,treesaver.json.stringify(n))}catch(s){}},treesaver.storage.get=function(t){var n=window.sessionStorage.getItem(t)||window.localStorage.getItem(t);return n?treesaver.json.parse(n):null},treesaver.storage.clear=function(t){(!SUPPORT_IE||window.sessionStorage.getItem(t))&&window.sessionStorage.removeItem(t),(!SUPPORT_IE||window.localStorage.getItem(t))&&window.localStorage.removeItem(t)},treesaver.storage.getKeys_=function(e){var t=[],n,r,i,s;e=e||"",s=e.length;for(n=0,r=window.localStorage.length;n<r;n+=1)i=window.localStorage.key(n),i&&(!e||e===i.substr(0,s))&&t.push(window.localStorage.key(n));for(n=0,r=window.sessionStorage.length;n<r;n+=1)i=window.sessionStorage.key(n),t.indexOf(i)===-1&&(!e||e===i.substr(0,s))&&t.push(i);return t},treesaver.storage.clean=function(t,n){var r=[];treesaver.storage.getKeys_(t).forEach(function(e){(!n||n.indexOf(e)===-1)&&treesaver.storage.clear(e)})},treesaver.capabilities.SUPPORTS_LOCALSTORAGE||(treesaver.debug.warn("Using fake localStorage"),treesaver.storage.dataStore_={},treesaver.storage.set=function(t,n,r){treesaver.storage.dataStore_[t]=n},treesaver.storage.get=function(t){return treesaver.storage.dataStore_[t]},treesaver.storage.clear=function(t){delete treesaver.storage.dataStore_[t]},treesaver.storage.getKeys_=function(e){return[]}),goog.provide("treesaver.ui.ArticleManager"),goog.require("treesaver.debug"),goog.require("treesaver.dimensions"),goog.require("treesaver.dom"),goog.require("treesaver.events"),goog.require("treesaver.microdata"),goog.require("treesaver.network"),goog.require("treesaver.resources"),goog.require("treesaver.storage"),goog.require("treesaver.ui.Article"),treesaver.ui.ArticleManager.CACHE_STORAGE_PREFIX="cache:",treesaver.ui.ArticleManager.load=function(e){treesaver.ui.ArticleManager.currentArticle=null,treesaver.ui.ArticleManager.currentPosition=null,treesaver.ui.ArticleManager.currentPageIndex=-1,treesaver.ui.ArticleManager.currentArticleIndex=null,treesaver.ui.ArticleManager.currentTransitionDirection=null,treesaver.ui.ArticleManager.currentPageWidth=null,treesaver.ui.ArticleManager.articleOrder=[],treesaver.ui.ArticleManager.articleMap={},treesaver.ui.ArticleManager.articles={},treesaver.ui.ArticleManager.toc=[],treesaver.ui.ArticleManager.grids_=treesaver.ui.ArticleManager.getGrids_();if(!treesaver.ui.ArticleManager.grids_)return treesaver.debug.error("No grids"),!1;treesaver.ui.ArticleManager.initLoadingPage(),treesaver.ui.ArticleManager.initErrorPage(),treesaver.ui.ArticleManager.initialUrl=treesaver.network.stripHash(document.location.href),treesaver.ui.ArticleManager.initialHTML=e;if(e){var t=new treesaver.ui.Article(treesaver.ui.ArticleManager.initialUrl,document.title,treesaver.ui.ArticleManager.grids_,e);t.error?(treesaver.debug.warn("Error in initial article"),treesaver.core.unload()):(treesaver.ui.ArticleManager.articles[treesaver.ui.ArticleManager.initialUrl]=t,treesaver.ui.ArticleManager._setArticle(t,null,0,!0))}else treesaver.debug.warn("No initial article");return treesaver.ui.ArticleManager.watchedEvents.forEach(function(e){treesaver.events.addListener(document,e,treesaver.ui.ArticleManager.handleEvent)}),window.onpopstate=treesaver.ui.ArticleManager.onPopState,treesaver.ui.ArticleManager.generateTOC(),!0},treesaver.ui.ArticleManager.getGrids_=function(){var e=[];return treesaver.resources.findByClassName("grid").forEach(function(t){var n=t.getAttribute("data-requires"),r;if(!n||treesaver.capabilities.check(n.split(" ")))r=new treesaver.layout.Grid(t),r.error||e.push(r)}),e},treesaver.ui.ArticleManager.initLoadingPage=function(){var e=treesaver.resources.findByClassName("loading")[0];e||(e=document.createElement("div")),document.body.appendChild(e),e.style.top="50%",treesaver.dimensions.setCssPx(e,"margin-top",-treesaver.dimensions.getOffsetHeight(e)/2),document.body.removeChild(e),treesaver.ui.ArticleManager.loadingPageHTML=treesaver.dom.outerHTML(e),e=e.cloneNode(!0),document.body.appendChild(e),treesaver.ui.ArticleManager.loadingPageSize=new treesaver.dimensions.Metrics(e),document.body.removeChild(e)},treesaver.ui.ArticleManager.initErrorPage=function(){var e=treesaver.resources.findByClassName("error")[0];e||(e=document.createElement("div")),document.body.appendChild(e),e.style.top="50%",treesaver.dimensions.setCssPx(e,"margin-top",treesaver.dimensions.getOffsetHeight(e)/2),document.body.removeChild(e),treesaver.ui.ArticleManager.errorPageHTML=treesaver.dom.outerHTML(e),e=e.cloneNode(!0),document.body.appendChild(e),treesaver.ui.ArticleManager.errorPageSize=new treesaver.dimensions.Metrics(e),document.body.removeChild(e)},treesaver.ui.ArticleManager.unload=function(){treesaver.ui.ArticleManager.currentArticle=null,treesaver.ui.ArticleManager.currentPosition=null,treesaver.ui.ArticleManager.currentPageIndex=null,treesaver.ui.ArticleManager.currentArticleIndex=null,treesaver.ui.ArticleManager.currentTransitionDirection=null,treesaver.ui.ArticleManager.articleOrder=null,treesaver.ui.ArticleManager.articleMap=null,treesaver.ui.ArticleManager.articles=null,treesaver.ui.ArticleManager.toc=null,treesaver.ui.ArticleManager.loadingPageHTML=null,treesaver.ui.ArticleManager.loadingPageSize=null,treesaver.ui.ArticleManager.watchedEvents.forEach(function(e){treesaver.events.removeListener(document,e,treesaver.ui.ArticleManager.handleEvent)}),window.onpopstate=null},treesaver.ui.ArticleManager.events={TOCUPDATED:"treesaver.tocupdated",ARTICLECHANGED:"treesaver.articlechanged",PAGESCHANGED:"treesaver.pageschanged"},treesaver.ui.ArticleManager.transitionDirection={FORWARD
:1,NEUTRAL:0,BACKWARD:-1},treesaver.ui.ArticleManager.watchedEvents=[treesaver.ui.Article.events.LOADED,treesaver.ui.Article.events.LOADFAILED,treesaver.ui.Article.events.PAGINATIONPROGRESS],treesaver.ui.ArticleManager.handleEvent=function(e){if(e.type===treesaver.ui.Article.events.PAGINATIONPROGRESS){treesaver.events.fireEvent(document,treesaver.ui.ArticleManager.events.PAGESCHANGED);return}if(e.type===treesaver.ui.Article.events.LOADED){treesaver.events.fireEvent(document,treesaver.ui.ArticleManager.events.PAGESCHANGED);return}if(e.type===treesaver.ui.Article.events.LOADFAILED&&e.article===treesaver.ui.ArticleManager.currentArticle){treesaver.ui.ArticleManager._redirectToArticle(treesaver.ui.ArticleManager.currentArticle);return}},treesaver.ui.ArticleManager.onPopState=function(e){treesaver.debug.info("onPopState event received: "+(e.state?e.state.url:"No URL"));if(e.state){var t=e.state.index;t||t===0?treesaver.ui.ArticleManager._setArticle(treesaver.ui.ArticleManager.articleOrder[t],e.state.position,t,!0):treesaver.ui.ArticleManager.goToArticleByURL(e.state.url)}else treesaver.ui.ArticleManager.goToArticleByURL(treesaver.ui.ArticleManager.initialUrl)},treesaver.ui.ArticleManager.getTOCLocation=function(){var e=treesaver.dom.getElementsByProperty("rel","contents","link")[0],t;return!e||e.getAttribute("rel").indexOf("self")!==-1?t=treesaver.ui.ArticleManager.initialUrl:t=treesaver.network.absoluteURL(e.href),t},treesaver.ui.ArticleManager.generateTOC=function(){var e=treesaver.ui.ArticleManager.getTOCLocation();e===treesaver.ui.ArticleManager.initialUrl&&(!treesaver.network.loadedFromCache()||!treesaver.network.isOnline())?treesaver.ui.ArticleManager.findTOCLinks(treesaver.ui.ArticleManager.initialHTML,e):treesaver.network.get(e,treesaver.ui.ArticleManager.findTOCLinks)},treesaver.ui.ArticleManager.findTOCLinks=function(e,t){var n=t===treesaver.ui.ArticleManager.initialUrl;if(e)WITHIN_IOS_WRAPPER||treesaver.storage.set(treesaver.ui.ArticleManager.CACHE_STORAGE_PREFIX+t,e,!0),n&&treesaver.network.loadedFromCache()&&treesaver.network.isOnline()&&(treesaver.ui.ArticleManager.currentArticle.processHTML(e),treesaver.events.fireEvent(document,treesaver.ui.ArticleManager.events.PAGESCHANGED));else{WITHIN_IOS_WRAPPER||(e=treesaver.storage.get(treesaver.ui.ArticleManager.CACHE_STORAGE_PREFIX+t));if(!e)return}var r=[],i=!1;treesaver.ui.ArticleManager.parseTOC(e),treesaver.ui.ArticleManager.toc.forEach(function(e){var n,s,o;e.flags.self?(n=t,e.fields.url=t,i=!0):n=treesaver.network.absoluteURL(e.fields.url),s=treesaver.ui.ArticleManager.articles[n],o=treesaver.ui.ArticleManager.articleOrder.length,s||(s=new treesaver.ui.Article(n,e.fields.title||"",treesaver.ui.ArticleManager.grids_),treesaver.ui.ArticleManager.articles[n]=s),treesaver.ui.ArticleManager.articleMap[n]?treesaver.ui.ArticleManager.articleMap[n].push(o):(treesaver.ui.ArticleManager.articleMap[n]=[o],r.push(treesaver.ui.ArticleManager.CACHE_STORAGE_PREFIX+n),n===treesaver.ui.ArticleManager.initialUrl&&(treesaver.ui.ArticleManager.currentArticleIndex=o)),treesaver.ui.ArticleManager.articleOrder.push(s)}),WITHIN_IOS_WRAPPER||treesaver.storage.clean(treesaver.ui.ArticleManager.CACHE_STORAGE_PREFIX,r),treesaver.events.fireEvent(document,treesaver.ui.ArticleManager.events.TOCUPDATED)},treesaver.ui.ArticleManager.parseTOC=function(e){var t=document.createElement("div"),n=[];SUPPORT_IE&&(t.className="offscreen",document.body.appendChild(t)),t.innerHTML=e,n=treesaver.microdata.getJSONItems(null,t),treesaver.ui.ArticleManager.toc=n.map(function(e){var t=treesaver.object.keys(e.properties),n={fields:{},flags:e.flags||{}};return t.forEach(function(t){n.fields[t]=e.properties[t][0]}),n}),SUPPORT_IE&&document.body.removeChild(t)},treesaver.ui.ArticleManager.canGoToPreviousPage=function(){return treesaver.ui.ArticleManager.currentPageIndex!==-1?treesaver.ui.ArticleManager.currentPageIndex>=1?!0:treesaver.ui.ArticleManager.canGoToPreviousArticle():!treesaver.ui.ArticleManager.currentPosition&&treesaver.ui.ArticleManager.canGoToPreviousArticle()},treesaver.ui.ArticleManager.previousPage=function(){if(goog.DEBUG&&!treesaver.ui.ArticleManager.currentArticle)return treesaver.debug.error("Tried to go to previous article without an article"),!1;if(treesaver.ui.ArticleManager.currentPageIndex===-1)return!treesaver.ui.ArticleManager.currentPosition&&treesaver.ui.ArticleManager.previousArticle(!0)?!0:!1;var e=treesaver.ui.ArticleManager.currentPageIndex-1;return e<0?treesaver.ui.ArticleManager.previousArticle(!0)?!0:!1:(treesaver.ui.ArticleManager.currentPageIndex=e,treesaver.ui.ArticleManager.currentPosition=null,treesaver.ui.ArticleManager.currentTransitionDirection=treesaver.ui.ArticleManager.transitionDirection.BACKWARD,treesaver.events.fireEvent(document,treesaver.ui.ArticleManager.events.PAGESCHANGED),!0)},treesaver.ui.ArticleManager.canGoToNextPage=function(){return treesaver.ui.ArticleManager.currentPageIndex!==-1?treesaver.ui.ArticleManager.currentPageIndex<treesaver.ui.ArticleManager.currentArticle.pageCount-1?!0:treesaver.ui.ArticleManager.currentArticle.paginationComplete&&treesaver.ui.ArticleManager.canGoToNextArticle():treesaver.ui.ArticleManager.currentPosition===treesaver.layout.ContentPosition.END?treesaver.ui.ArticleManager.canGoToNextArticle():!1},treesaver.ui.ArticleManager.nextPage=function(){if(goog.DEBUG&&!treesaver.ui.ArticleManager.currentArticle)return treesaver.debug.error("Tried to go to next page without an article"),!1;if(treesaver.ui.ArticleManager.currentPageIndex===-1)return treesaver.ui.ArticleManager.currentPosition===treesaver.layout.ContentPosition.END&&treesaver.ui.ArticleManager.nextArticle()?!0:!1;var e=treesaver.ui.ArticleManager.currentPageIndex+1;if(e>=treesaver.ui.ArticleManager.currentArticle.pageCount)return treesaver.ui.ArticleManager.currentArticle.paginationComplete?treesaver.ui.ArticleManager.nextArticle()?!0:!1:!1;return treesaver.ui.ArticleManager.currentPageIndex=e,treesaver.ui.ArticleManager.currentPosition=null,treesaver.ui.ArticleManager.currentTransitionDirection=treesaver.ui.ArticleManager.transitionDirection.FORWARD,treesaver.events.fireEvent(document,treesaver.ui.ArticleManager.events.PAGESCHANGED),!0},treesaver.ui.ArticleManager.canGoToPreviousArticle=function(){return!!treesaver.ui.ArticleManager.currentArticleIndex},treesaver.ui.ArticleManager.previousArticle=function(e,t){if(!treesaver.ui.ArticleManager.canGoToPreviousArticle())return null;var n=treesaver.ui.ArticleManager.currentArticleIndex-1,r=treesaver.ui.ArticleManager.articleOrder[n];return t?r:treesaver.ui.ArticleManager._setArticle(r,e?treesaver.layout.ContentPosition.END:null,n)},treesaver.ui.ArticleManager.canGoToNextArticle=function(){return(!!treesaver.ui.ArticleManager.currentArticleIndex||treesaver.ui.ArticleManager.currentArticleIndex===0)&&treesaver.ui.ArticleManager.currentArticleIndex<treesaver.ui.ArticleManager.articleOrder.length-1},treesaver.ui.ArticleManager.nextArticle=function(e){if(!treesaver.ui.ArticleManager.canGoToNextArticle())return null;var t=treesaver.ui.ArticleManager.currentArticleIndex+1,n=treesaver.ui.ArticleManager.articleOrder[t];return e?n:treesaver.ui.ArticleManager._setArticle(n,null,t)},treesaver.ui.ArticleManager.goToArticleByURL=function(e,t){var n=treesaver.ui.ArticleManager._getArticleIndex(e),r;return!n&&n!==0?!1:(r=treesaver.ui.ArticleManager.articleOrder[n],treesaver.ui.ArticleManager._setArticle(r,null,n))},treesaver.ui.ArticleManager.getPages=function(e,t){treesaver.ui.ArticleManager.currentTransitionDirection=treesaver.ui.ArticleManager.transitionDirection.NEUTRAL,treesaver.ui.ArticleManager.currentArticle.setMaxPageSize(e)&&(treesaver.ui.ArticleManager.currentPageIndex=-1,treesaver.ui.ArticleManager.currentPageWidth=0);var n=[],r,i,s,o=2*t+1,u,a,f,l;if(treesaver.ui.ArticleManager.currentPageIndex===-1){treesaver.ui.ArticleManager.currentPageIndex=treesaver.ui.ArticleManager.currentArticle.getPageIndex(treesaver.ui.ArticleManager.currentPosition);if(treesaver.ui.ArticleManager.currentPageIndex===-1)return n.length=o,n[t]=treesaver.ui.ArticleManager._createLoadingPage(),n}s=treesaver.ui.ArticleManager.currentPageIndex-t;if(s<0){r=treesaver.ui.ArticleManager.previousArticle(!1,!0);if(r&&r.content&&r.paginationComplete)n=r.getPages(s,-s);else for(a=0,l=-s;a<l;a+=1)n[a]=null;u=o+s,s=0}else u=o;n=n.concat(treesaver.ui.ArticleManager.currentArticle.getPages(s,u)),u=o-n.length,u&&(i=treesaver.ui.ArticleManager.nextArticle(!0),i&&(i.content?n=n.concat(i.getPages(0,u)):(treesaver.ui.ArticleManager._loadArticle(i),i.setMaxPageSize(e),n.length=o)));for(a=t,l=n.length;a<l;a+=1)n[a]||(treesaver.ui.ArticleManager.currentArticle.error?n[a]=treesaver.ui.ArticleManager._createErrorPage():n[a]=treesaver.ui.ArticleManager._createLoadingPage());(!treesaver.ui.ArticleManager.currentPosition||treesaver.ui.ArticleManager.currentPosition===treesaver.layout.ContentPosition.END)&&n[t]&&n[t].begin&&(treesaver.ui.ArticleManager.currentPosition=n[t].begin),treesaver.ui.ArticleManager.currentPageWidth||(treesaver.ui.ArticleManager.currentPageWidth=treesaver.ui.ArticleManager.currentArticle.getPageWidth());for(a=0;a<n.length;a+=1)for(f=a+1;f<n.length;f+=1)n[a]===n[f]&&(n[f]=n[a].clone());return n},treesaver.ui.ArticleManager.getCurrentUrl=function(){return treesaver.ui.ArticleManager.currentArticle.url},treesaver.ui.ArticleManager.getCurrentPageNumber=function(){return treesaver.ui.ArticleManager.currentPageIndex+1||1},treesaver.ui.ArticleManager.getCurrentPageCount=function(){return treesaver.ui.ArticleManager.currentArticle.pageCount||1},treesaver.ui.ArticleManager.getCurrentPageWidth=function(){return treesaver.ui.ArticleManager.currentPageWidth},treesaver.ui.ArticleManager.getCurrentTransitionDirection=function(){return treesaver.ui.ArticleManager.currentTransitionDirection},treesaver.ui.ArticleManager.getFigure=function(e){var t=parseInt(e.getAttribute("data-figureindex"),10);return isNaN(t)?null:treesaver.ui.ArticleManager.currentArticle.content.figures[t]},treesaver.ui.ArticleManager.getCurrentTOC=function(){return treesaver.ui.ArticleManager.toc||[]},treesaver.ui.ArticleManager._getArticleIndex=function(e,t){var n=treesaver.ui.ArticleManager.articleMap[e],r,i;if(!n||!n.length)return null;if(n.length===1)return n[0];r=n.length-1;while(r>=0){i=n[r];if(i===treesaver.ui.ArticleManager.currentArticleIndex)return i;if(i<treesaver.ui.ArticleManager.currentArticleIndex)return t&&r!==n.length-1?n[r+1]:i;r-=1}return i},treesaver.ui.ArticleManager._redirectToArticle=function(e){treesaver.network.isOnline()?document.location=e.url:treesaver.debug.error("Tried to redirect to an article while offline")},treesaver.ui.ArticleManager._loadArticle=function(e){if(e.loading)return;e.loading=!0;if(!WITHIN_IOS_WRAPPER){var t=treesaver.storage.get(treesaver.ui.ArticleManager.CACHE_STORAGE_PREFIX+e.url);t&&(e.processHTML(t),treesaver.events.fireEvent(document,treesaver.ui.Article.events.LOADED,{article:e}))}treesaver.debug.info("loadArticle: Downloading article: "+e.url),treesaver.network.get(e.url,function(n){e.loading=!1;if(!n){if(WITHIN_IOS_WRAPPER||!t){treesaver.debug.info("loadArticle: Load failed, no content: "+e.url),e.loadFailed=!0,treesaver.events.fireEvent(document,treesaver.ui.Article.events.LOADFAILED,{article:e});return}treesaver.debug.log("Using cached content for article: "+e.url)}else WITHIN_IOS_WRAPPER||t!==n?(WITHIN_IOS_WRAPPER||(treesaver.debug.log("Fetched content newer than cache for article: "+e.url),treesaver.storage.set(treesaver.ui.ArticleManager.CACHE_STORAGE_PREFIX+e.url,n,!0)),treesaver.debug.log("Processing HTML content for article: "+e.url),e.processHTML(n),treesaver.events.fireEvent(document,treesaver.ui.Article.events.LOADED,{article:e})):treesaver.debug.log("Fetched content same as cached")})},treesaver.ui.ArticleManager._setArticle=function(e,t,n,r){if(!e)return!1;if(treesaver.ui.ArticleManager.currentArticle===e&&n===treesaver.ui.ArticleManager.currentArticleIndex)return!0;e.title&&(document.title=e.title),treesaver.ui.ArticleManager.currentArticle=e,treesaver.ui.ArticleManager._setPosition(t),treesaver.ui.ArticleManager.currentPageIndex=-1;if(!e.loaded)treesaver.ui.ArticleManager._loadArticle(e);else if(e.error)return treesaver.ui.ArticleManager._redirectToArticle(e),!1;return n||n===0?(treesaver.ui.ArticleManager.currentTransitionDirection=treesaver.ui.ArticleManager.currentArticleIndex>n?treesaver.ui.ArticleManager.transitionDirection.BACKWARD:treesaver.ui.ArticleManager.transitionDirection.FORWARD,treesaver.ui.ArticleManager.currentArticleIndex=n):(treesaver.ui.ArticleManager.currentTransitionDirection=treesaver.ui.ArticleManager.transitionDirection.NEUTRAL,treesaver.ui.ArticleManager.currentArticleIndex=treesaver.ui.ArticleManager._getArticleIndex(e.url)),r?treesaver.history.replaceState({index:n,url:e.url,position:t},e.title,e.path):treesaver.history.pushState({index:n,url:e.url,position:t},e.title,e.path),treesaver.events.fireEvent(document,treesaver.ui.ArticleManager.events.PAGESCHANGED),treesaver.events.fireEvent(document,treesaver.ui.ArticleManager.events.ARTICLECHANGED,{article:e,url:e.url,path:e.path}),!0},treesaver.ui.ArticleManager._setPosition=function(e){if(treesaver.ui.ArticleManager.currentPosition===e)return;treesaver.ui.ArticleManager.currentPosition=e,treesaver.ui.ArticleManager.currentPageIndex=-1},treesaver.ui.ArticleManager._createLoadingPage=function(){return{activate:treesaver.layout.Page.prototype.activate,deactivate:treesaver.layout.Page.prototype.deactivate,html:treesaver.ui.ArticleManager.loadingPageHTML,size:treesaver.ui.ArticleManager.loadingPageSize}},treesaver.ui.ArticleManager._createErrorPage=function(){return{activate:treesaver.layout.Page.prototype.activate,deactivate:treesaver.layout.Page.prototype.deactivate,html:treesaver.ui.ArticleManager.errorPageHTML,size:treesaver.ui.ArticleManager.errorPageSize}},WITHIN_IOS_WRAPPER&&(goog.exportSymbol("treesaver.canGoToNextPage",treesaver.ui.ArticleManager.canGoToNextPage),goog.exportSymbol("treesaver.canGoToPreviousPage",treesaver.ui.ArticleManager.canGoToPreviousPage),goog.exportSymbol("treesaver.canGoToNextArticle",treesaver.ui.ArticleManager.canGoToNextArticle),goog.exportSymbol("treesaver.canGoToPreviousArticle",treesaver.ui.ArticleManager.canGoToPreviousArticle),goog.exportSymbol("treesaver.getCurrentUrl",treesaver.ui.ArticleManager.getCurrentUrl),goog.exportSymbol("treesaver.getCurrentPageNumber",treesaver.ui.ArticleManager.getCurrentPageNumber),goog.exportSymbol("treesaver.getCurrentPageCount",treesaver.ui.ArticleManager.getCurrentPageCount),goog.exportSymbol("treesaver.goToArticleByURL",treesaver.ui.ArticleManager.goToArticleByURL)),goog.provide("treesaver.ui.Scrollable"),treesaver.ui.Scrollable=function(e){this.node=e,this.contentContainer=e.firstChild},treesaver.ui.Scrollable.prototype.contentContainer,treesaver.ui.Scrollable.prototype.node,treesaver.ui.Scrollable.prototype.viewportSize,treesaver.ui.Scrollable.prototype.contentSize,treesaver.ui.Scrollable.prototype.scrollPosX,treesaver.ui.Scrollable.prototype.scrollPosY,treesaver.ui.Scrollable.prototype.refreshDimensions=function(){this.viewportSize=treesaver.dimensions.getSize(this.node),this.contentSize=treesaver.dimensions.getSize(this.contentContainer),this.scrollPosX=this.scrollPosX||0,this.scrollPosY=this.scrollPosY||0,this.setOffset(0,0,!0)},treesaver.ui.Scrollable.prototype.contains=function(e){return this.contentContainer.contains(e)},treesaver.ui.Scrollable.prototype.cropOffset=function(e,t){return{x:Math.max(0,Math.min(this.contentSize.w-this.viewportSize.w,e)),y:Math.max(0,Math.min(this.contentSize.h-this.viewportSize.h,t))}},treesaver.ui.Scrollable.prototype.setOffset=function(e,t,n){var r=this.cropOffset(this.scrollPosX+e,this.scrollPosY+t);n&&(this.scrollPosY=r.y,this.scrollPosX=r.x),treesaver.dimensions.setOffset(this.contentContainer,-r.x,-r.y)},treesaver.ui.Scrollable.initDom=function(e){var t=document.createElement("div");treesaver.dom.addClass(t,"scroll-container"),(WITHIN_IOS_WRAPPER||treesaver.capabilities.SUPPORTS_TOUCH)&&e.setAttribute("onclick","void(0)");while(e.firstChild)t.appendChild(e.firstChild);e.appendChild(t)},goog.provide("treesaver.ui.Chrome"),goog.require("treesaver.capabilities"),goog.require("treesaver.constants"),goog.require("treesaver.debug"),goog.require("treesaver.dimensions"),goog.require("treesaver.dom"),goog.require("treesaver.network"),goog.require("treesaver.scheduler"),goog.require("treesaver.template"),goog.require("treesaver.ui.ArticleManager"),goog.require("treesaver.ui.Scrollable"),treesaver.ui.Chrome=function(e){goog.DEBUG&&(treesaver.dom.getElementsByClassName("viewer",e).length||treesaver.debug.error("Chrome does not have a viewer"),e.parentNode.childNodes.length!==1&&treesaver.debug.error("Chrome is not only child in container")),this.requirements=treesaver.dom.hasAttr(e,"data-requires")?e.getAttribute("data-requires").split(" "):null,treesaver.dom.getElementsByClassName("scroll",e).forEach(treesaver.ui.Scrollable.initDom),this.scrollers=[],this.node=null,this.html=e.parentNode.innerHTML,this.size=new treesaver.dimensions.Metrics(e),delete this.size.w,delete this.size.h,this.pageArea=null,this.active=!1,this.viewer=null,this.pageNum=null,this.pageCount=null,this.pageWidth=null,this.toc=null,this.tocTemplate=null,this.pages=null,this.uiActive=!1,this.menu=null,this.lightBoxActive=!1,this.lightBox=null,this.currentURL=null,this.sidebar=null,this.nextPage=null,this.nextArticle=null,this.prevPage=null,this.prevArticle=null},treesaver.ui.Chrome.prototype.activate=function(){var e=[],t=[],n=[],r=[];return this.active||(this.active=!0,this.node=treesaver.dom.createElementFromHTML(this.html),this.viewer=treesaver.dom.getElementsByClassName("viewer",this.node)[0],this.pageNum=treesaver.template.getElementsByBindName("pagenumber",null,this.node),this.pageCount=treesaver.template.getElementsByBindName("pagecount",null,this.node),this.pageWidth=treesaver.dom.getElementsByClassName("pagewidth",this.node),this.currentURL=treesaver.template.getElementsByBindName("current-url",null,this.node),this.nextPage=treesaver.dom.getElementsByClassName("next",this.node),this.nextArticle=treesaver.dom.getElementsByClassName("nextArticle",this.node),this.prevPage=treesaver.dom.getElementsByClassName("prev",this.node),this.prevArticle=treesaver.dom.getElementsByClassName("prevArticle",this.node),this.scrollers=treesaver.dom.getElementsByClassName("scroll",this.node).map(function(e){return new treesaver.ui.Scrollable(e)}),n=treesaver.dom.getElementsByClassName("menu",this.node),n.length>0&&(this.menu=n[0]),e=treesaver.template.getElementsByBindName("toc",null,this.node),e.length>=1&&(this.toc=e[0],this.tocTemplate=this.toc.cloneNode(!0)),r=treesaver.dom.getElementsByClassName("sidebar",this.node),r.length>0&&(this.sidebar=r[0]),this.pages=[],treesaver.ui.Chrome.watchedEvents.forEach(function(e){treesaver.events.addListener(document,e,this)},this),this.uiActive=!1,this.setUiActive_()),this.node},treesaver.ui.Chrome.prototype.deactivate=function(){if(!this.active)return;this.stopDelayedFunctions(),this.active=!1,treesaver.ui.Chrome.watchedEvents.forEach(function(e){treesaver.events.removeListener(document,e,this)},this),this.node=null,this.viewer=null,this.pageNum=null,this.pageCount=null,this.pageWidth=null,this.menu=null,this.currentURL=null,this.toc=null,this.tocTemplate=null,this.sidebar=null,this.nextPage=null,this.nextArticle=null,this.prevPage=null,this.prevArticle=null,this.pages.forEach(function(e){e&&e.deactivate()}),this.pages=null,this.pageArea=null},treesaver.ui.Chrome.prototype.stopDelayedFunctions=function(){treesaver.scheduler.clear("selectPages"),treesaver.scheduler.clear("animatePages")},treesaver.ui.Chrome.events={ACTIVE:"treesaver.active",IDLE:"treesaver.idle"},treesaver.ui.Chrome.watchedEvents=[treesaver.ui.ArticleManager.events.TOCUPDATED,treesaver.ui.ArticleManager.events.PAGESCHANGED,treesaver.ui.ArticleManager.events.ARTICLECHANGED,"keydown","click","mousewheel","DOMMouseScroll"],treesaver.capabilities.SUPPORTS_TOUCH?treesaver.ui.Chrome.watchedEvents.push("touchstart","touchmove","touchend","touchcancel"):treesaver.ui.Chrome.watchedEvents.push("mouseover"),treesaver.ui.Chrome.prototype.handleEvent=function(e){switch(e.type){case treesaver.ui.ArticleManager.events.PAGESCHANGED:return this.selectPagesDelayed();case treesaver.ui.ArticleManager.events.TOCUPDATED:return this.updateTOCDelayed(),this.selectPagesDelayed();case treesaver.ui.ArticleManager.events.ARTICLECHANGED:return this.updateTOCActive(e),this.updatePageURL(e);case"mouseover":return this.mouseOver(e);case"touchstart":return this.touchStart(e);case"touchmove":return this.touchMove(e);case"touchend":return this.touchEnd(e);case"touchcancel":return this.touchCancel(e);case"keydown":return this.keyDown(e);case"click":return this.click(e);case"mousewheel":case"DOMMouseScroll":return this.mouseWheel(e)}},treesaver.ui.Chrome.specialKeyPressed_=function(e){return e.ctrlKey||e.shiftKey||e.altKey||e.metaKey},treesaver.ui.Chrome.prototype.keyDown=function(e){if(this.lightBoxActive){this.hideLightBox(),e.preventDefault();return}if(!treesaver.ui.Chrome.specialKeyPressed_(e)){switch(e.keyCode){case 34:case 39:case 40:case 74:case 32:treesaver.ui.ArticleManager.nextPage();break;case 33:case 37:case 38:case 75:treesaver.ui.ArticleManager.previousPage();break;case 72:treesaver.ui.ArticleManager.previousArticle();break;case 76:treesaver.ui.ArticleManager.nextArticle();break;default:return}this.setUiIdle_(),e.preventDefault()}},treesaver.ui.Chrome.prototype.click=function(e){if(this.lightBoxActive){this.hideLightBox(),e.stopPropagation(),e.preventDefault();return}if(treesaver.ui.Chrome.specialKeyPressed_(e))return!0;if("which"in e&&e.which!==1||e.button){treesaver.debug.info("Click ignored due to non-left click");return}var t=treesaver.ui.Chrome.findTarget_(e.target),n,r=!1,i=!1,s=!1,o=!1;this.isMenuActive()&&(o=this.menu.contains(t),this.menuInactive()),this.isSidebarActive()&&(s=this.sidebar.contains(t),s||this.sidebarInactive()),t=t;if(this.pages[0]&&this.pages[0].node.contains(t))treesaver.ui.ArticleManager.previousPage(),i=!0;else if(this.pages[2]&&this.pages[2].node.contains(t))treesaver.ui.ArticleManager.nextPage(),i=!0;else{r=this.pages[1]&&this.pages[1].node.contains(t);while(!i&&t&&t!==treesaver.boot.tsContainer){r?treesaver.dom.hasClass(t,"zoomable")&&(i=this.showLightBox(t)):treesaver.dom.hasClass(t,"prev")?(treesaver.ui.ArticleManager.previousPage(),i=!0):treesaver.dom.hasClass(t,"next")?(treesaver.ui.ArticleManager.nextPage(),i=!0):treesaver.dom.hasClass(t,"prevArticle")?(treesaver.ui.ArticleManager.previousArticle(),i=!0):treesaver.dom.hasClass(t,"nextArticle")?(treesaver.ui.ArticleManager.nextArticle(),i=!0):treesaver.dom.hasClass(t,"menu")?(o||this.menuActive(),i=!0):treesaver.dom.hasClass(t,"sidebar")||treesaver.dom.hasClass(t,"open-sidebar")?(this.isSidebarActive()||this.sidebarActive(),i=!0):treesaver.dom.hasClass(t,"close-sidebar")&&this.isSidebarActive()&&(this.sidebarInactive(),i=!0);if(!i&&t.href&&t.nodeName.toLowerCase()!=="img"){if(t.getAttribute("target")==="lightbox"){t=t.parentNode;continue}n=treesaver.network.absoluteURL(t.href);if(!treesaver.ui.ArticleManager.goToArticleByURL(n))return;i=!0}t=t.parentNode}}i&&(e.stopPropagation(),e.preventDefault())},treesaver.ui.Chrome.prototype.lastMouseWheel_,treesaver.ui.Chrome.prototype.mouseWheel=function(e){if(treesaver.ui.Chrome.specialKeyPressed_(e))return!0;if(this.lightBoxActive){this.hideLightBox(),e.preventDefault();return}var t=goog.now();if(this.lastMouseWheel_&&t-this.lastMouseWheel_<MOUSE_WHEEL_INTERVAL)return;this.lastMouseWheel_=t;var n=e.wheelDelta?e.wheelDelta:e.detail?-e.detail:0,r=this.viewer.contains(treesaver.ui.Chrome.findTarget_(e.target));if(!n||!r)return;e.preventDefault(),e.stopPropagation(),n>0?treesaver.ui.ArticleManager.previousPage():treesaver.ui.ArticleManager.nextPage(),this.setUiIdle_()},treesaver.ui.Chrome.findTarget_=function(e){return e?e.nodeType!==1&&e.parentNode&&(e=e.parentNode||treesaver.boot.tsContainer):e=treesaver.boot.tsContainer,e},treesaver.ui.Chrome.prototype.touchData_,treesaver.ui.Chrome.prototype.touchStart=function(e){if(!treesaver.boot.tsContainer.contains(treesaver.ui.Chrome.findTarget_(e.target)))return;e.stopPropagation(),e.preventDefault();if(this.lightBoxActive){this.hideLightBox();return}this.touchData_={startTime:goog.now(),deltaTime:0,startX:e.touches[0].pageX,startY:e.touches[0].pageY,deltaX:0,deltaY:0,touchCount:e.touches.length},this.touchData_.touchCount===2&&(this.touchData_.startX2=e.touches[1].pageX),this.scrollers.forEach(function(t){t.contains(treesaver.ui.Chrome.findTarget_(e.target))&&(this.touchData_.scroller=t)},this),treesaver.scheduler.pause([],2*SWIPE_TIME_LIMIT)},treesaver.ui.Chrome.prototype.touchMove=function(e){if(!this.touchData_)return;e.stopPropagation(),e.preventDefault(),this.touchData_.lastMove=goog.now(),this.touchData_.lastX=e.touches[0].pageX,this.touchData_.lastY=e.touches[0].pageY,this.touchData_.deltaTime=this.touchData_.lastMove-this.touchData_.startTime,this.touchData_.deltaX=this.touchData_.lastX-this.touchData_.startX,this.touchData_.deltaY=this.touchData_.lastY-this.touchData_.startY,this.touchData_.touchCount=Math.min(e.touches.length,this.touchData_.touchCount),this.touchData_.swipe=this.touchData_.touchCount===1&&Math.abs(this.touchData_.deltaX)>=SWIPE_THRESHOLD,this.touchData_.scroller?this.touchData_.scroller.setOffset(this.touchData_.deltaX,-this.touchData_.deltaY):this.touchData_.swipe?(this.pageOffset=this.touchData_.deltaX,this._updatePagePositions(!0)):this.pageOffset?(this.animationStart=goog.now(),this._updatePagePositions(treesaver.capabilities.SUPPORTS_CSSTRANSITIONS)):this.touchData_.touchCount===2&&(this.touchData_.deltaX2=e.touches[1].pageX-this.touchData_.startX2)},treesaver.ui.Chrome.prototype.touchEnd=function(e){var t=this.touchData_,n=!1;this.touchCancel(e);if(!t)return;e.stopPropagation(),e.preventDefault();if(t.scroller&&t.lastMove)t.scroller.setOffset(t.deltaX,-t.deltaY,!0);else if(t.touchCount===1){if(!t.lastMove){var r=treesaver.ui.Chrome.findTarget_(e.target),i=this.lightBoxActive||this.viewer.contains(r),s=document.createEvent("MouseEvents");s.initMouseEvent("click",!0,!0,e.view,1,e.changedTouches[0].screenX,e.changedTouches[0].screenY,e.changedTouches[0].clientX,e.changedTouches[0].clientY,e.ctrlKey,e.altKey,e.shiftKey,e.metaKey,0,null),r.dispatchEvent(s)&&i?this.toggleUiActive_():i?this.setUiIdle_():this.setUiActive_(),n=!0}else if(t.swipe||t.deltaY<=-SWIPE_THRESHOLD)t.swipe&&t.deltaX>0?n=treesaver.ui.ArticleManager.previousPage():n=treesaver.ui.ArticleManager.nextPage(),n?this.setUiIdle_():this.setUiActive_()}else t.touchCount===2&&Math.abs(t.deltaX2)>=SWIPE_THRESHOLD&&(t.deltaX<0&&t.deltaX2<0?n=treesaver.ui.ArticleManager.nextArticle():t.deltaX>0&&t.deltaX2>0&&(n=treesaver.ui.ArticleManager.previousArticle()),n?this.setUiIdle_():this.setUiActive_());n||(this.animationStart=goog.now(),this.pageOffset=0,this._updatePagePositions(treesaver.capabilities.SUPPORTS_CSSTRANSITIONS))},treesaver.ui.Chrome.prototype.touchCancel=function(e){treesaver.scheduler.resume(),this.touchData_=null},treesaver.ui.Chrome.prototype.mouseOver=function(e){e.touches||this.setUiActive_()},treesaver.ui.Chrome.prototype.setUiActive_=function(){this.uiActive||(this.uiActive=!0,treesaver.dom.addClass(this.node,"active"),treesaver.events.fireEvent(document,treesaver.ui.Chrome.events.ACTIVE)),treesaver.scheduler.debounce(this.setUiIdle_,UI_IDLE_INTERVAL,null,!1,"idletimer",this)},treesaver.ui.Chrome.prototype.setUiIdle_=function(){this.uiActive&&(this.uiActive=!1,treesaver.dom.removeClass(this.node,"active"),treesaver.events.fireEvent(document,treesaver.ui.Chrome.events.IDLE)),treesaver.scheduler.clear("idletimer")},treesaver.ui.Chrome.prototype.toggleUiActive_=function(){this.uiActive?this.setUiIdle_():this.setUiActive_()},treesaver.ui.Chrome.prototype.menuActive=function(){treesaver.dom.addClass(this.node,"menu-active")},treesaver.ui.Chrome.prototype.menuInactive=function(){treesaver.dom.removeClass(this.node,"menu-active")},treesaver.ui.Chrome.prototype.isMenuActive=function(){return treesaver.dom.hasClass(this.node,"menu-active")},treesaver.ui.Chrome.prototype.sidebarActive=function(){treesaver.dom.addClass(this.node,"sidebar-active")},treesaver.ui.Chrome.prototype.sidebarInactive=function(){treesaver.dom.removeClass(this.node,"sidebar-active")},treesaver.ui.Chrome.prototype.isSidebarActive=function(){return treesaver.dom.hasClass(this.node,"sidebar-active")},treesaver.ui.Chrome.prototype.showLightBox=function(e){var t=treesaver.ui.ArticleManager.getFigure(e);if(!t)return!1;this.setUiIdle_();if(!this.lightBoxActive){this.lightBox=treesaver.ui.StateManager.getLightBox();if(!this.lightBox)return!1;this.lightBoxActive=!0,this.lightBox.activate(),this.node.parentNode.appendChild(this.lightBox.node)}return this.lightBox.node=this.lightBox.node,treesaver.dimensions.setCssPx(this.lightBox.node,"width",treesaver.dimensions.getOffsetWidth(this.node)),treesaver.dimensions.setCssPx(this.lightBox.node,"height",treesaver.dimensions.getOffsetHeight(this.node)),this.lightBox.showFigure(t)?!0:(this.hideLightBox(),!1)},treesaver.ui.Chrome.prototype.hideLightBox=function(){this.lightBoxActive&&(this.lightBoxActive=!1,this.node.parentNode.removeChild(this.lightBox.node),this.lightBox.deactivate(),this.lightBox=null)},treesaver.ui.Chrome.prototype.meetsRequirements=function(){return this.requirements?treesaver.capabilities.check(this.requirements,!0):!0},treesaver.ui.Chrome.prototype.fits=function(e){return treesaver.dimensions.inSizeRange(this.size,e)},treesaver.ui.Chrome.prototype.calculatePageArea=function(){goog.DEBUG&&(this.viewer||treesaver.debug.error("No viewer in chrome")),this.pageArea={w:treesaver.dimensions.getOffsetWidth(this.viewer),h:treesaver.dimensions.getOffsetHeight(this.viewer)}},treesaver.ui.Chrome.prototype.setSize=function(e){treesaver.dimensions.setCssPx(this.node,"width",e.w),treesaver.dimensions.setCssPx(this.node,"height",e.h),this.pageArea=null,this.calculatePageArea(),this.scrollers.forEach(function(e){e.refreshDimensions()}),treesaver.ui.ArticleManager.currentArticle&&(this.selectPagesDelayed(),this.updateTOCDelayed())},treesaver.ui.Chrome.prototype.updatePageURL=function(e){this.currentURL.forEach(function(t){treesaver.template.expand({"current-url":e.url},t)})},treesaver.ui.Chrome.prototype.updateTOCActive=function(e){if(this.toc){var t=treesaver.ui.ArticleManager.getCurrentTOC(),n=treesaver.template.getElementsByBindName("article",null,this.toc),r=0;t.forEach(function(e,t){!e.flags.hidden&&n[r]&&(t===treesaver.ui.ArticleManager.currentArticleIndex?treesaver.dom.addClass(n[r],"current"):treesaver.dom.removeClass(n[r],"current"),r+=1)}),this.scrollers.forEach(function(e){e.refreshDimensions()})}},treesaver.ui.Chrome.prototype.updatePageIndex=function(e){this.pageNum.forEach(function(t){treesaver.template.expand({pagenumber:e},t)})},treesaver.ui.Chrome.prototype.updatePageCount=function(e){this.pageCount.forEach(function(t){treesaver.template.expand({pagecount:e},t)})},treesaver.ui.Chrome.prototype.updatePageWidth=function(e){e&&this.pageWidth.forEach(function(t){treesaver.dimensions.setCssPx(t,"width",e)},this)},treesaver.ui.Chrome.prototype.setElementState=function(e,t){e.nodeName==="BUTTON"?e.disabled=!t:t?treesaver.dom.removeClass(e,"disabled"):treesaver.dom.addClass(e,"disabled")},treesaver.ui.Chrome.prototype.updateNextPageState=function(){if(this.nextPage){var e=treesaver.ui.ArticleManager.canGoToNextPage();this.nextPage.forEach(function(t){this.setElementState(t,e)},this)}},treesaver.ui.Chrome.prototype.updateNextArticleState=function(){if(this.nextArticle){var e=treesaver.ui.ArticleManager.canGoToNextArticle();this.nextArticle.forEach(function(t){this.setElementState(t,e)},this)}},treesaver.ui.Chrome.prototype.updatePreviousPageState=function(){if(this.prevPage){var e=treesaver.ui.ArticleManager.canGoToPreviousPage();this.prevPage.forEach(function(t){this.setElementState(t,e)},this)}},treesaver.ui.Chrome.prototype.updatePreviousArticleState=function(){if(this.prevArticle){var e=treesaver.ui.ArticleManager.canGoToPreviousArticle();this.prevArticle.forEach(function(t){this.setElementState(t,e)},this)}},treesaver.ui.Chrome.prototype.selectPagesDelayed=function(){treesaver.scheduler.queue(this.selectPages,[],"selectPages",this)},treesaver.ui.Chrome.prototype.updateTOCDelayed=function(){treesaver.scheduler.queue(this.updateTOC,[],"updateTOC",this)},treesaver.ui.Chrome.prototype.selectPages=function(){this.stopDelayedFunctions();var e=treesaver.ui.ArticleManager.getCurrentTransitionDirection();this.populatePages(e),this.layoutPages(e),this.
updateFields(),this.updateNextPageState(),this.updateNextArticleState(),this.updatePreviousPageState(),this.updatePreviousArticleState()},treesaver.ui.Chrome.prototype.updateTOC=function(){treesaver.scheduler.clear("updateTOC");if(this.toc){var e=treesaver.ui.ArticleManager.getCurrentTOC(),t=this.tocTemplate.cloneNode(!0),n=this.toc.parentNode;e=e.filter(function(e){return!e.flags.hidden}),e=e.map(function(e){return{article:e.fields}}),treesaver.template.expand({toc:e},t),n.replaceChild(t,this.toc),this.toc=t,treesaver.events.fireEvent(document,treesaver.ui.ArticleManager.events.ARTICLECHANGED,{article:treesaver.ui.ArticleManager.currentArticle,url:treesaver.ui.ArticleManager.currentArticle.url,path:treesaver.ui.ArticleManager.currentArticle.path})}},treesaver.ui.Chrome.prototype.populatePages=function(e){var t=this.pages;this.pages=treesaver.ui.ArticleManager.getPages(this.pageArea,1),t.forEach(function(e){e&&this.pages.indexOf(e)===-1&&(e.node&&e.node.parentNode===this.viewer&&this.viewer.removeChild(e.node),e.deactivate())},this),this.pages.forEach(function(t,n){t&&(t.node||t.activate(),t.node.parentNode!==this.viewer&&(e===treesaver.ui.ArticleManager.transitionDirection.BACKWARD?this.viewer.insertBefore(t.node,this.viewer.firstChild):this.viewer.appendChild(t.node)))},this)},treesaver.ui.Chrome.prototype.layoutPages=function(e){var t=this.pages[0],n=this.pages[1],r=this.pages[2],i,s,o=Math.max(n.size.marginRight,r?r.size.marginLeft:0),u=Math.max(n.size.marginLeft,t?t.size.marginRight:0),a=this.pageOffset;n.node.setAttribute("id","currentPage"),i=(this.pageArea.w-n.size.outerW)/2-o,s=i+n.size.outerW+o+u,this.pagePositions=[],this.pagePositions[1]=i,t&&(this.pagePositions[0]=i-(t.size.outerW+t.size.marginLeft),t.node.setAttribute("id","previousPage")),r&&(this.pagePositions[2]=s-r.size.marginLeft,r.node.setAttribute("id","nextPage")),e!==treesaver.ui.ArticleManager.transitionDirection.NEUTRAL?(this.animationStart=goog.now(),e===treesaver.ui.ArticleManager.transitionDirection.BACKWARD?(this.pageOffset=r?this.pagePositions[1]-this.pagePositions[2]:0,a&&(this.pageOffset+=a)):(this.pageOffset=t?this.pagePositions[1]-this.pagePositions[0]:0,a&&(this.pageOffset+=a))):this.pageOffset||(this.pageOffset=0),treesaver.capabilities.SUPPORTS_CSSTRANSITIONS&&this.pageOffset&&(this.pageOffset=0),this._updatePagePositions(treesaver.capabilities.SUPPORTS_CSSTRANSITIONS)},treesaver.ui.Chrome.prototype._updatePagePositionsDelayed=function(){treesaver.scheduler.queue(this.selectPages,[],"animatePages",this)},treesaver.ui.Chrome.prototype._updatePagePositions=function(e){var t=this.pageOffset;if(!e){treesaver.scheduler.pause(["animatePages"],2*MAX_ANIMATION_DURATION);var n=goog.now(),r=e?1:Math.max(0,(this.animationStart||0)+MAX_ANIMATION_DURATION-n)/MAX_ANIMATION_DURATION,i=-Math.cos(r*Math.PI)/2+.5;t*=i,Math.abs(t)<5?(this.pageOffset=t=0,treesaver.scheduler.resume()):this._updatePagePositionsDelayed()}this.pages.forEach(function(e,n){e&&e.node&&treesaver.dimensions.setOffsetX(e.node,this.pagePositions[n]+t)},this)},treesaver.ui.Chrome.prototype.updateFields=function(){this.updatePageIndex(treesaver.ui.ArticleManager.getCurrentPageNumber()),this.updatePageCount(treesaver.ui.ArticleManager.getCurrentPageCount()),this.updatePageWidth(treesaver.ui.ArticleManager.getCurrentPageWidth())},treesaver.ui.Chrome.select=function(e,t){var n,r,i,s=null;for(n=0,r=e.length;n<r;n+=1){i=e[n];if(i.meetsRequirements()&&i.fits(t)){s=i;break}}return s||treesaver.debug.error("No Chrome Fits!"),s},goog.DEBUG&&(treesaver.ui.Chrome.prototype.toString=function(){return"[Chrome: ]"}),goog.provide("treesaver.ui.LightBox"),goog.require("treesaver.capabilities"),goog.require("treesaver.debug"),goog.require("treesaver.dimensions"),goog.require("treesaver.dom"),goog.require("treesaver.layout.Container"),goog.require("treesaver.layout.Figure"),treesaver.ui.LightBox=function(e){var t=treesaver.dom.getElementsByClassName("container",e)[0];goog.DEBUG&&(t||treesaver.debug.error("No container within lightbox!")),this.requirements=treesaver.dom.hasAttr(e,"data-requires")?e.getAttribute("data-requires").split(" "):null,this.html=e.parentNode.innerHTML,this.size=new treesaver.dimensions.Metrics(e),delete this.size.w,delete this.size.h,this.active=!1,this.node=null,this.container=null},treesaver.ui.LightBox.prototype.activate=function(){return this.active||(this.active=!0,this.node=treesaver.dom.createElementFromHTML(this.html),this.container=treesaver.dom.getElementsByClassName("container",this.node)[0]),this.node},treesaver.ui.LightBox.prototype.deactivate=function(){if(!this.active)return;this.active=!1,this.node=null},treesaver.ui.LightBox.prototype.getMaxSize=function(){return goog.DEBUG&&(!this.node||!this.container)&&treesaver.debug.error("No active container for lightbox"),{w:treesaver.dimensions.getOffsetWidth(this.container),h:treesaver.dimensions.getOffsetHeight(this.container)}},treesaver.ui.LightBox.prototype.showFigure=function(e){var t=e.getLargestSize(this.getMaxSize()),n=treesaver.dimensions.getOffsetWidth(this.container.offsetParent),r=treesaver.dimensions.getOffsetHeight(this.container.offsetParent);return this.container=this.container,this.active&&t?(t.figureSize.applySize(this.container,t.name),this.container.style.bottom="auto",this.container.style.right="auto",treesaver.dimensions.setCssPx(this.container,"left",(n-treesaver.dimensions.getOffsetWidth(this.container))/2),treesaver.dimensions.setCssPx(this.container,"top",(r-treesaver.dimensions.getOffsetHeight(this.container))/2),!0):!1},treesaver.ui.LightBox.prototype.fits=function(e){return treesaver.dimensions.inSizeRange(this.size,e)},treesaver.ui.LightBox.prototype.meetsRequirements=function(){return this.requirements?treesaver.capabilities.check(this.requirements,!0):!0},treesaver.ui.LightBox.select=function(e,t){var n,r,i,s=null;for(n=0,r=e.length;n<r;n+=1){i=e[n];if(i.meetsRequirements()&&i.fits(t)){s=i;break}}return s||treesaver.debug.error("No LightBox Fits!"),s},goog.provide("treesaver.ui.StateManager"),goog.require("treesaver.capabilities"),goog.require("treesaver.constants"),goog.require("treesaver.debug"),goog.require("treesaver.dom"),goog.require("treesaver.events"),goog.require("treesaver.resources"),goog.require("treesaver.ui.Chrome"),goog.require("treesaver.ui.LightBox"),treesaver.ui.StateManager.state_,treesaver.ui.StateManager.chromes_,treesaver.ui.StateManager.load=function(){return treesaver.ui.StateManager.state_={orientation:0,size:{w:0,h:0}},treesaver.dom.clearChildren(treesaver.boot.tsContainer),treesaver.ui.StateManager.state_.chromeContainer=treesaver.ui.StateManager.getChromeContainer_(),treesaver.ui.StateManager.state_.viewport=treesaver.ui.StateManager.getViewport_(),treesaver.ui.StateManager.chromes_=treesaver.ui.StateManager.getChromes_(),treesaver.ui.StateManager.lightboxes_=treesaver.ui.StateManager.getLightBoxes_(),treesaver.ui.StateManager.chromes_.length?(treesaver.ui.StateManager.checkState(),treesaver.scheduler.repeat(treesaver.ui.StateManager.checkState,CHECK_STATE_INTERVAL,Infinity,[],"checkState"),treesaver.capabilities.SUPPORTS_ORIENTATION&&!treesaver.boot.inContainedMode&&(treesaver.events.addListener(window,"orientationchange",treesaver.ui.StateManager.onOrientationChange),treesaver.scheduler.delay(function(){window.scrollTo(0,1)},100)),!0):(treesaver.debug.error("No chromes"),!1)},treesaver.ui.StateManager.unload=function(){treesaver.capabilities.SUPPORTS_ORIENTATION&&!treesaver.boot.inContainedMode&&treesaver.events.removeListener(window,"orientationchange",treesaver.ui.StateManager.onOrientationChange),treesaver.ui.StateManager.state_.chrome&&treesaver.ui.StateManager.state_.chrome.deactivate(),treesaver.ui.StateManager.state_=null,treesaver.ui.StateManager.chromes_=null,treesaver.ui.StateManager.lightboxes_=null},treesaver.ui.StateManager.getChromeContainer_=function(){if(treesaver.boot.inContainedMode)return treesaver.boot.tsContainer;var e=document.createElement("div");return e.setAttribute("id","chromeContainer"),treesaver.boot.tsContainer.appendChild(e),e},treesaver.ui.StateManager.getViewport_=function(){var e=treesaver.dom.getElementsByProperty("name","viewport","meta")[0];return e||(e=document.createElement("meta"),e.setAttribute("name","viewport"),treesaver.dom.getElementsByTagName("head")[0].appendChild(e)),e},treesaver.ui.StateManager.getChromes_=function(){var e=[];return treesaver.resources.findByClassName("chrome").forEach(function(t){var n,r=t.getAttribute("data-requires");if(r&&!treesaver.capabilities.check(r.split(" ")))return;treesaver.ui.StateManager.state_.chromeContainer.appendChild(t),n=new treesaver.ui.Chrome(t),e.push(n),treesaver.ui.StateManager.state_.chromeContainer.removeChild(t)}),e},treesaver.ui.StateManager.getLightBoxes_=function(){var e=[];return treesaver.resources.findByClassName("lightbox").forEach(function(t){var n,r=t.getAttribute("data-requires");if(r&&!treesaver.capabilities.check(r.split(" ")))return;treesaver.ui.StateManager.state_.chromeContainer.appendChild(t),n=new treesaver.ui.LightBox(t),e.push(n),treesaver.ui.StateManager.state_.chromeContainer.removeChild(t)}),e},treesaver.ui.StateManager.onOrientationChange=function(){if(treesaver.ui.StateManager.state_.orientation===window.orientation)return;treesaver.capabilities.updateClasses(),treesaver.ui.StateManager.state_.orientation=window.orientation,treesaver.ui.StateManager.state_.orientation%180?treesaver.ui.StateManager.state_.viewport.setAttribute("content","width=device-height, height=device-width"):treesaver.ui.StateManager.state_.viewport.setAttribute("content","width=device-width, height=device-height"),window.scrollTo(0,1)},treesaver.ui.StateManager.getAvailableSize_=function(){return WITHIN_IOS_WRAPPER||!treesaver.boot.inContainedMode?((window.pageYOffset||window.pageXOffset)&&window.scrollTo(0,1),!SUPPORT_IE||"innerWidth"in window?{w:window.innerWidth,h:window.innerHeight}:{w:document.documentElement.clientWidth,h:document.documentElement.clientHeight}):treesaver.dimensions.getSize(treesaver.boot.tsContainer)},treesaver.ui.StateManager.getLightBox=function(){var e=treesaver.ui.StateManager.getAvailableSize_();return treesaver.ui.LightBox.select(treesaver.ui.StateManager.lightboxes_,e)},treesaver.ui.StateManager.checkState=function(){var e=treesaver.ui.StateManager.getAvailableSize_(),t;if(e.h!==treesaver.ui.StateManager.state_.size.h||e.w!==treesaver.ui.StateManager.state_.size.w){treesaver.ui.StateManager.state_.size=e;if(!treesaver.ui.StateManager.state_.chrome||!treesaver.ui.StateManager.state_.chrome.meetsRequirements()||!treesaver.ui.StateManager.state_.chrome.fits(e)){t=treesaver.ui.Chrome.select(treesaver.ui.StateManager.chromes_,e);if(!t)return;treesaver.dom.clearChildren(treesaver.ui.StateManager.state_.chromeContainer),treesaver.ui.StateManager.state_.chrome&&treesaver.ui.StateManager.state_.chrome.deactivate(),treesaver.ui.StateManager.state_.chromeContainer.appendChild(t.activate()),treesaver.ui.StateManager.state_.chrome=t}treesaver.ui.StateManager.state_.chrome.setSize(e)}};if(WITHIN_IOS_WRAPPER){var activeFunctionWrapper=function(e){return function(){treesaver.ui.StateManager.state_.chrome&&treesaver.ui.StateManager.state_.chrome.setUiActive_(),e()}};goog.exportSymbol("treesaver.nextPage",activeFunctionWrapper(treesaver.ui.ArticleManager.nextPage)),goog.exportSymbol("treesaver.previousPage",activeFunctionWrapper(treesaver.ui.ArticleManager.previousPage)),goog.exportSymbol("treesaver.nextArticle",activeFunctionWrapper(treesaver.ui.ArticleManager.nextArticle)),goog.exportSymbol("treesaver.previousArticle",activeFunctionWrapper(treesaver.ui.ArticleManager.previousArticle))}goog.provide("treesaver.core"),goog.require("treesaver.debug"),goog.require("treesaver.styles"),goog.require("treesaver.ui.Article"),goog.require("treesaver.ui.ArticleManager"),goog.require("treesaver.ui.Chrome"),goog.require("treesaver.ui.StateManager"),treesaver.core.load=function(){treesaver.debug.info("Core load begin"),treesaver.events.addListener(window,"unload",treesaver.core.unload),treesaver.ui.eventRoot=treesaver.boot.inContainedMode?treesaver.boot.tsContainer:window;if(!treesaver.ui.StateManager.load()||!treesaver.ui.ArticleManager.load(treesaver.boot.originalHtml))treesaver.debug.error("Load failed"),treesaver.core.unload()},treesaver.core.unload=function(){treesaver.debug.info("Core unloading"),treesaver.events.removeListener(window,"unload",treesaver.core.unload),treesaver.ui.ArticleManager.unload(),treesaver.ui.StateManager.unload(),treesaver.boot.unload()},goog.provide("treesaver.domready"),goog.require("treesaver.events"),goog.require("treesaver.scheduler"),treesaver.domready.events={READY:"treesaver.ready"},treesaver.domready.ready=function(){return treesaver.domready.documentReady_},treesaver.domready.loaded=function(){return treesaver.domready.documentLoaded_},treesaver.domready.documentReady_=!1,treesaver.domready.documentLoaded_=!1,treesaver.domready.ready_=function(){if(treesaver.domready.documentReady_)return;if(!document.body){treesaver.debug.error("DOMReady without document.body"),treesaver.debug.info("Requeue domReady handler in order to wait for document.body"),treesaver.scheduler.queue(treesaver.domready.ready_);return}treesaver.domready.documentReady_=!0,treesaver.debug.info("DOM is ready"),treesaver.events.removeListener(document,"DOMContentLoaded",treesaver.domready),treesaver.events.removeListener(document,"readystatechange",treesaver.domready),treesaver.events.removeListener(window,"load",treesaver.domready),delete treesaver.domready.elementCount_,treesaver.events.fireEvent(document,treesaver.domready.events.READY)},treesaver.domready.elementCount_,treesaver.domready.pollState_=function(){if("readyState"in document){/complete|loaded/.test(document.readyState)&&treesaver.domready.ready_();return}treesaver.debug.info("Manually polling document ready state");var e=document.getElementsByTagName("*").length;if(!treesaver.domready.elementCount_)treesaver.domready.elementCount_=e,treesaver.scheduler.delay(treesaver.domready.pollState_,100);else if(e===treesaver.domready.elementCount_){treesaver.domready.ready_();return}},treesaver.domready.handleEvent=function(e){treesaver.debug.info("DOM event received: "+e.type),/load|DOMContentLoaded/.test(e.type)?treesaver.domready.ready_():treesaver.domready.pollState_()},treesaver.events.addListener(document,"DOMContentLoaded",treesaver.domready),treesaver.events.addListener(document,"readystatechange",treesaver.domready),treesaver.events.addListener(window,"load",treesaver.domready),treesaver.domready.pollState_(),goog.provide("treesaver.modules"),treesaver.modules={"treesaver-init":{target:"treesaver-init-0.9.2.js",src:"init.js"},"treesaver-core":{target:"treesaver-core-0.9.2.js",src:"core.js"}},treesaver.modules.get=function(e){return treesaver.modules[e][COMPILED?"target":"src"]},goog.provide("treesaver.scriptloader"),goog.require("treesaver.constants"),goog.require("treesaver.dom"),goog.require("treesaver.modules"),treesaver.scriptloader.BASE_FILENAME=treesaver.modules.get("treesaver-init"),treesaver.scriptloader.load=function(e,t){var n=document.createElement("script");n.type="text/javascript",n.setAttribute("async","async"),treesaver.dom.safeAppendToDocument(n),n.onload=n.onreadystatechange=function(r){r||(r=window.event),r.type==="load"||"readyState"in n&&(n.readyState==="complete"||n.readyState==="loaded")?(treesaver.debug.info("Asynchronous load complete: "+e),n.onload=n.onreadystatechange=null,t(e)):treesaver.debug.info("Extra script loading event recieved: "+r.type)},treesaver.debug.info("Begin asynchronous load: "+e),n.src=treesaver.scriptloader.getUrlFromName_(e)},treesaver.scriptloader.getUrlFromName_=function(e){if(SUPPORT_IE){if(e.charAt(0)==="/"||/:\/\//.test(e))return e}else if(e[0]==="/"||/:\/\//.test(e))return e;return treesaver.scriptloader.getScriptPath_()+e},treesaver.scriptloader.scriptPath_,treesaver.scriptloader.getScriptPath_=function(){if(!treesaver.scriptloader.scriptPath_){var e="",t=document.getElementsByTagName("script");treesaver.array.toArray(t).forEach(function(t){!e&&t.src.indexOf(treesaver.scriptloader.BASE_FILENAME)!==-1&&(e=t.getAttribute("src"))});if(!e)return treesaver.debug.error("Could not find script path"),"";treesaver.scriptloader.scriptPath_=treesaver.scriptloader.getDirectoryName_(e)}return treesaver.scriptloader.scriptPath_},treesaver.scriptloader.getDirectoryName_=function(e){var t=e.lastIndexOf("/");return e.substr(0,t+1)},goog.provide("treesaver.boot"),goog.require("treesaver.capabilities"),goog.require("treesaver.constants"),goog.require("treesaver.debug"),goog.require("treesaver.dom"),goog.require("treesaver.domready"),goog.require("treesaver.events"),goog.require("treesaver.modules"),goog.require("treesaver.resources"),goog.require("treesaver.scheduler"),goog.require("treesaver.scriptloader"),treesaver.boot.LOAD_TIMEOUT=5e3,treesaver.boot.load=function(){treesaver.debug.info("Begin Treesaver booting");if(!goog.DEBUG||!window.TS_NO_AUTOLOAD)document.documentElement.style.display="none";treesaver.network.load(),treesaver.capabilities.updateClasses(),treesaver.resources.load(function(){treesaver.boot.resourcesLoaded_=!0,treesaver.boot.loadProgress_()});if(USE_MODULES){if(!COMPILED){var e=goog.require;try{e("treesaver.core")}catch(t){}}treesaver.scriptloader.load(treesaver.modules.get("treesaver-core"),function(e){treesaver.boot.coreLoaded_=!0,treesaver.boot.loadProgress_()})}treesaver.domready.ready()?treesaver.boot.domReady():treesaver.events.addListener(document,treesaver.domready.events.READY,treesaver.boot.domReady),(!goog.DEBUG||!window.TS_NO_AUTOLOAD)&&treesaver.scheduler.delay(treesaver.boot.unload,treesaver.boot.LOAD_TIMEOUT,[],"unboot")},treesaver.boot.unload=function(){treesaver.debug.info("Treesaver unbooting"),!WITHIN_IOS_WRAPPER&&treesaver.boot.inContainedMode?treesaver.boot.tsContainer.innerHTML=treesaver.boot.originalContainerHtml:treesaver.boot.originalHtml&&(treesaver.boot.tsContainer.innerHTML=treesaver.boot.originalHtml),treesaver.boot.cleanup_(),treesaver.scheduler.stopAll(),treesaver.resources.unload(),treesaver.network.unload(),treesaver.capabilities.resetClasses(),document.documentElement.style.display="block"},treesaver.boot.cleanup_=function(){treesaver.scheduler.clear("unboot"),treesaver.events.removeListener(document,treesaver.domready.events.READY,treesaver.boot.domReady),delete treesaver.boot.resourcesLoaded_,USE_MODULES&&delete treesaver.boot.coreLoaded_,delete treesaver.boot.domReady_},treesaver.boot.domReady=function(e){treesaver.boot.domReady_=!0,WITHIN_IOS_WRAPPER||(treesaver.boot.tsContainer=document.getElementById("ts_container")),!WITHIN_IOS_WRAPPER&&treesaver.boot.tsContainer?(treesaver.boot.inContainedMode=!0,treesaver.boot.originalContainerHtml=treesaver.boot.tsContainer.innerHTML):(treesaver.boot.inContainedMode=!1,treesaver.boot.tsContainer=document.body),treesaver.boot.originalHtml=document.body.innerHTML,treesaver.dom.clearChildren(treesaver.boot.tsContainer);if(!goog.DEBUG||!window.TS_NO_AUTOLOAD)treesaver.boot.tsContainer.innerHTML='<div id="loading">Loading '+document.title+"...</div>",document.documentElement.style.display="block";treesaver.boot.loadProgress_()},treesaver.boot.loadProgress_=function(){if(!treesaver.boot.resourcesLoaded_)return;if(USE_MODULES&&!treesaver.boot.coreLoaded_)return;if(!treesaver.boot.domReady_){treesaver.debug.info("Load progress: DOM not ready yet");return}if(!document.body){treesaver.debug.error("document.body not available after DOM ready");return}treesaver.debug.info("Treesaver boot complete"),treesaver.boot.cleanup_(),(!goog.DEBUG||!window.TS_NO_AUTOLOAD)&&treesaver.core.load()},goog.provide("treesaver.history"),goog.require("treesaver.capabilities"),goog.require("treesaver.debug"),goog.require("treesaver.dom"),goog.require("treesaver.scheduler"),goog.require("treesaver.storage"),treesaver.history.HASH_INTERVAL=100,treesaver.history.DELIMITER="-",treesaver.history.NATIVE_SUPPORT="pushState"in window.history,treesaver.history.getNormalizedHash_=function(){var e=document.location.href.indexOf("#");return e===-1?"":document.location.href.substr(e+1)};if(document.location.hash){var current_hash=treesaver.history.getNormalizedHash_();current_hash.charAt(0)===treesaver.history.DELIMITER&&current_hash.length>=2&&document.location.replace(current_hash.substr(1))}treesaver.history.pushState=function(e,t,n){window.history.pushState(e,t,n)},treesaver.history.replaceState=function(e,t,n){window.history.replaceState(e,t,n)},treesaver.history.NATIVE_SUPPORT||(treesaver.debug.info("Using non-native history implementation"),treesaver.history.pushState=function(e,t,n){treesaver.history._changeState(e,t,n,!1)},treesaver.history.replaceState=function(e,t,n){treesaver.history._changeState(e,t,n,!0)},treesaver.history.createHash_=function(e){return treesaver.history.DELIMITER+window.escape(e)},treesaver.history.setLocationHash_=function(e){document.location.hash="#"+e},treesaver.history.replaceLocationHash_=function(e){document.location.replace("#"+e)},treesaver.history.STORAGE_PREFIX="history:",treesaver.history.createStorageKey_=function(e){return treesaver.history.STORAGE_PREFIX+e},treesaver.history._changeState=function(t,n,r,i){var s=treesaver.history.createHash_(r);treesaver.storage.set(treesaver.history.createStorageKey_(s),{state:t,title:n}),r===document.location.pathname&&(s=""),treesaver.history.hash_=s,i?treesaver.history.replaceLocationHash_(s):treesaver.history.setLocationHash_(s)},treesaver.history.hashChange_=function(){var t=treesaver.history.getNormalizedHash_(),n;if(t===treesaver.history.hash_)return;treesaver.history.hash_=t,n=treesaver.history.hash_?treesaver.storage.get(treesaver.history.createStorageKey_(t)):{},treesaver.debug.info("New hash: "+treesaver.history.hash_),"onpopstate"in window&&typeof window.onpopstate=="function"?window.onpopstate.apply(window,[{state:n?n.state:null}]):treesaver.debug.info("State changed, but no handler!")},treesaver.history.hasHashChanged_=function(){return treesaver.history.getNormalizedHash_()!==treesaver.history.hash_},"onhashchange"in window&&!treesaver.capabilities.IS_IE8INIE7?(treesaver.debug.info("Browser has native onHashChange"),window.onhashchange=treesaver.history.hashChange_):(treesaver.debug.info("Using manual hash change detection"),treesaver.scheduler.repeat(function(){treesaver.history.hasHashChanged_()&&treesaver.history.hashChange_()},treesaver.history.HASH_INTERVAL,Infinity),SUPPORT_IE&&treesaver.capabilities.BROWSER_NAME==="msie"&&(treesaver.debug.info("Using iFrame history for IE7"),treesaver.history.dummyIFrame_=document.createElement("iframe"),treesaver.dom.safeAppendToDocument(treesaver.history.dummyIFrame_),treesaver.history.hasHashChanged_=function(){var e=treesaver.history.dummyIFrame_.contentWindow.document.body.innerHTML;if(e!==treesaver.history.hash_)return document.location.hash="#"+(e||""),!0},treesaver.history.replaceLocationHash_=function(e){var t=treesaver.history.dummyIFrame_.contentWindow.document;e!==t.body.innerHTML&&(t.body.innerHTML=e),document.location.replace("#"+e)},treesaver.history.setLocationHash_=function(e){var t=treesaver.history.dummyIFrame_.contentWindow.document;t.open(),t.write("<html><body>"+e+"</body></html>"),t.close(),document.location.hash="#"+e}))),goog.provide("treesaver.html5"),goog.require("treesaver.constants"),SUPPORT_IE&&eval("/*@cc_on (function(a,b,c){while(b--)a.createElement(c[b])})(document,21,['abbr','article','aside','audio','canvas','details','figcaption','figure','footer','header','hgroup','mark','menu','meter','nav','output','progress','section','summary','time','video'])@*/"),goog.provide("treesaver"),goog.require("treesaver.boot"),goog.require("treesaver.capabilities"),goog.require("treesaver.constants"),goog.require("treesaver.debug"),goog.require("treesaver.history"),goog.require("treesaver.html5"),treesaver.capabilities.SUPPORTS_TREESAVER?treesaver.boot.load():treesaver.debug.warn("Treesaver not supported"),treesaver.VERSION="dev",goog.exportSymbol("treesaver.VERSION",treesaver.VERSION),goog.provide("treesaver.modules"),treesaver.modules={"treesaver-init":{target:"treesaver-init-0.9.2.js",src:"init.js"},"treesaver-core":{target:"treesaver-core-0.9.2.js",src:"core.js"}},treesaver.modules.get=function(e){return treesaver.modules[e][COMPILED?"target":"src"]};